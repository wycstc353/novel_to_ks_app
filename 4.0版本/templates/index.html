<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小说转 KAG (流式可选+NAI生成+模型本地化)</title> <!-- 更新标题 -->
    <style>
        /* [Styles 不变] */
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1100px; margin: 20px auto; background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; color: #555; }
        label.inline-label { display: inline-block; margin-right: 5px; margin-top: 0; vertical-align: middle; font-weight: normal;}
        input[type="text"], input[type="password"], input[type="number"], select, textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        input[type="checkbox"] { vertical-align: middle; margin-top: -2px; margin-right: 3px; width: auto;}
        textarea { min-height: 120px; font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; vertical-align: top; line-height: 1.5; background-color: #fff; resize: vertical; }
        .textarea-small { min-height: 60px; }
        .textarea-instruction { min-height: 50px; font-size: 0.9em; color: #444; }
        #structuredNovelText { background-color: #e8f4ff; }
        #enhancedNovelText { background-color: #fff8e1; }
        #outputKs { background-color: #e0e0e0; min-height: 200px; color: #333; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; margin-right: 10px; transition: background-color 0.2s ease; }
        button.secondary { background-color: #6c757d; }
        button.warning { background-color: #f0ad4e; }
        button:hover { background-color: #0056b3; }
        button.secondary:hover { background-color: #5a6268; }
        button.warning:hover { background-color: #ec971f; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; opacity: 0.7; }
        .status-indicator { margin-left: 10px; font-style: italic; font-size: 0.9em; color: #669; min-height: 1.2em; display: inline-block; vertical-align: middle;}
        #param-status, #nai-param-status { font-size: 0.85em; color: green; margin-top: 5px; min-height: 1em;}
        .error { color: #d9534f; font-weight: bold; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 15px; }
        .config-item { min-width: 0; }
        fieldset { margin-bottom: 25px; border: 1px solid #ddd; padding: 20px; border-radius: 5px; background-color: #fafafa;}
        legend { font-weight: bold; padding: 0 10px; color: #337ab7; font-size: 1.1em;}
        .step-container { margin-top: 25px; padding-top: 20px; border-top: 1px dashed #ccc;}
        h1 { text-align: center; color: #337ab7; margin-bottom: 20px;}
        p { color: #666; font-size: 0.95em; }
        .warning { color:#d9534f; font-weight:bold; border: 1px solid #d9534f; padding: 10px; border-radius: 4px; background-color: #fcf8e3;}
        .sound-path-label { font-size: 0.9em; color: #777; font-weight: normal; margin-top: 0; }
        #characterProfilesArea { border: 1px solid #bee5eb; background-color: #f0fcff; padding: 15px; border-radius: 5px; margin-top: 15px; }
        .profile-entry { display: grid; grid-template-columns: 150px auto auto 60px; gap: 10px; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #ddd;}
        .profile-entry input[type="text"] { margin-top: 0; font-size: 0.95em;}
        .profile-entry button { padding: 3px 8px; font-size: 0.9em; margin: 0; background-color: #dc3545; }
        .profile-entry input[data-type="name"] { font-weight: bold; }
        .filename-input { width: auto; display: inline-block; margin-right: 10px; max-width: 200px; vertical-align: middle; margin-top: 10px; }
        .prefix-input { width: auto; display: inline-block; margin-right: 10px; max-width: 150px; vertical-align: middle; margin-top: 10px;}
        .step3-controls { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        .debug-notice { font-size: 0.8em; color: #888; margin-top: 5px; display: block; }
        .debug-option { margin-top: 15px; margin-right: 20px; display: inline-block;} /* Adjust spacing */
        .streaming-option { margin-top: 15px; display: inline-block;} /* Container for streaming checkbox */
        .nai-config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px 20px; margin-bottom: 15px; }
        .nai-config-item label { margin-top: 5px;}
        .nai-config-item input, .nai-config-item select {margin-top: 0;}
        #naiImageGenStatus { font-weight: bold; min-height: 1.2em; display: inline-block; margin-top: 10px; vertical-align: middle;}
        .file-status { margin-left: 15px; font-style: italic; color: #555; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>小说转 KAG (流式可选+NAI生成+模型本地化)</h1>
        <p>说明：配置 LLM API (可选流式传输) -> 配置 NovelAI API (模型列表从本地JSON加载) -> 步骤一：格式化 -> (人物设定) -> 步骤二：加提示 -> 步骤三：转 KAG (脚本可编辑) -> (可选)生成图片。可保存/加载所有API设置。文件名可在保存时输入。</p>
        <p class="warning">警告：API Keys、文件路径等敏感信息会保存在服务器端 `config.json`。人物设定和 NAI 模型列表通过本地 JSON 文件管理。图片生成会调用 NovelAI API 并将图片保存在服务器指定目录，请确保目录存在且可写，并注意 API 额度消耗。</p>

        <form id="conversionForm" onsubmit="return false;">
            <fieldset>
                <legend>LLM API 与全局设置</legend>
                 {/* [API/生成参数/指令 不变] */}
                 <div class="config-grid"> <div class="config-item"> <label for="apiKey">LLM API Key:</label> <input type="password" id="apiKey" name="apiKey" required> </div> <div class="config-item"> <label for="apiEndpoint">LLM API Base URL:</label> <input type="text" id="apiEndpoint" name="apiEndpoint" placeholder="例如: https://generativelanguage.googleapis.com" required> </div> <div class="config-item"> <label for="modelName">LLM 模型名称:</label> <input type="text" id="modelName" name="modelName" placeholder="例如: gemini-1.5-flash-latest" required> </div> </div> <div class="config-grid"> <div class="config-item"> <label for="temperature">Temperature:</label> <input type="number" id="temperature" name="temperature" min="0" max="2" step="0.1" placeholder="例如: 0.1"> </div> <div class="config-item"> <label for="maxOutputTokens">Max Output Tokens:</label> <input type="number" id="maxOutputTokens" name="maxOutputTokens" min="1" step="1" placeholder="例如: 8192"> </div> </div> <div> <label for="preInstruction">全局前置指令 (可选, 应用于步骤二/三):</label> <textarea id="preInstruction" name="preInstruction" class="textarea-instruction" placeholder="(步骤一会忽略此指令)"></textarea> </div> <div> <label for="postInstruction">全局后置指令 (可选, 应用于步骤二/三):</label> <textarea id="postInstruction" name="postInstruction" class="textarea-instruction" placeholder="(步骤一会忽略此指令)"></textarea> </div> <hr style="margin: 15px 0;">
                 {/* [声音路径不变] */}
                 <div class="config-grid"> <div class="config-item"> <label for="successSoundPath">成功提示音路径:</label> <input type="text" id="successSoundPath" name="successSoundPath" placeholder="服务器可访问的完整路径"> <label class="sound-path-label">服务器端文件路径</label> </div> <div class="config-item"> <label for="failureSoundPath">失败提示音路径:</label> <input type="text" id="failureSoundPath" name="failureSoundPath" placeholder="服务器可访问的完整路径"> <label class="sound-path-label">服务器端文件路径</label> </div> </div>
                 {/* 新增流式选项 */}
                 <div>
                    <div class="streaming-option">
                         <input type="checkbox" id="enableStreamingCheckbox" name="enableStreamingCheckbox" checked>
                         <label for="enableStreamingCheckbox" class="inline-label">启用流式传输 (Streaming)?</label>
                     </div>
                     <div class="debug-option">
                         <input type="checkbox" id="saveDebugInputsCheckbox" name="saveDebugInputsCheckbox">
                         <label for="saveDebugInputsCheckbox" class="inline-label">保存发送内容调试文件?</label>
                     </div>
                 </div>
                 {/* 保存/加载按钮 */}
                 <div> <button type="button" id="saveParamsButton" class="secondary">保存 LLM 设置</button> <button type="button" id="loadParamsButton" class="secondary">加载 LLM 设置</button> <span id="param-status"></span> </div>
             </fieldset>

             <fieldset> <legend>NovelAI 图片生成设置</legend> {/* [内容不变] */} <div class="config-item"> <label for="naiApiKey">NovelAI API Key:</label> <input type="password" id="naiApiKey" name="naiApiKey"> </div> <div class="config-item"> <label for="naiImageSaveDir">图片保存目录 (服务器路径):</label> <input type="text" id="naiImageSaveDir" name="naiImageSaveDir" placeholder="例如: /path/to/save/images 或 D:/images"> </div> <div class="nai-config-grid"> <div class="nai-config-item"> <label for="naiModel">模型 (Model):</label> <div style="display: flex; align-items: center; gap: 10px;"> <select id="naiModel" name="naiModel" style="flex-grow: 1;"> <option value="">-- 请加载模型文件 --</option> </select> <button type="button" id="loadNaiModelsButton" class="secondary" style="padding: 5px 10px; font-size: 0.9em; margin-top: 0;">加载模型</button> </div> <span id="naiModelFileStatus" class="file-status">未加载模型文件</span> <input type="file" id="naiModelFileInput" accept=".json" style="display: none;"> </div> <div class="nai-config-item"> <label for="naiSampler">采样器 (Sampler):</label> <select id="naiSampler" name="naiSampler"> <option value="k_euler">k_euler</option> <option value="k_euler_ancestral">k_euler_ancestral</option> <option value="k_dpmpp_2s_ancestral">k_dpmpp_2s_ancestral</option> <option value="k_dpmpp_2m">k_dpmpp_2m</option> <option value="k_dpmpp_sde">k_dpmpp_sde</option> <option value="ddim">ddim</option> </select> </div> <div class="nai-config-item"> <label for="naiSteps">步数 (Steps):</label> <input type="number" id="naiSteps" name="naiSteps" min="1" max="100" value="28"> </div> <div class="nai-config-item"> <label for="naiScale">引导强度 (Scale/CFG):</label> <input type="number" id="naiScale" name="naiScale" min="0" max="30" step="0.1" value="7.0"> </div> <div class="nai-config-item"> <label for="naiSeed">种子 (Seed):</label> <input type="number" id="naiSeed" name="naiSeed" value="-1" step="1"> <label class="sound-path-label">-1 表示随机</label> </div> <div class="nai-config-item"> <label for="naiUcPreset">负面预设 (UC Preset):</label> <select id="naiUcPreset" name="naiUcPreset"> <option value="0">Heavy</option> <option value="1">Light</option> <option value="2">Human Focus</option> <option value="3">None</option> </select> </div> <div class="nai-config-item"> <label for="naiQualityToggle">质量标签 (Quality Toggle):</label> <input type="checkbox" id="naiQualityToggle" name="naiQualityToggle" checked> </div> </div> <div> <button type="button" id="saveNaiParamsButton" class="secondary">保存 NAI 设置</button> <span id="nai-param-status"></span> </div> </fieldset>
            <fieldset> <legend>人物设定 (用于生成 NAI 提示词)</legend> {/* [内容不变] */} <div id="characterProfilesArea"> <div> <button type="button" id="loadProfileFileButton" class="secondary">加载设定文件 (.json)</button> <button type="button" id="saveProfileFileButton" class="secondary" disabled>保存当前设定到文件</button> <span id="profileFileNameSpan" class="file-status">未加载文件</span> </div> <hr style="margin: 15px 0;"> <p style="font-size: 0.9em; color: #666;">加载文件后，您可以在下方编辑设定，或点击“添加人物”新增。编辑后记得点击“保存当前设定到文件”。</p> <div id="profilesList"></div> <button type="button" id="addProfileButton" class="secondary">添加人物</button> <span id="profile-status" style="font-size: 0.85em; margin-left: 10px;"></span> <input type="file" id="profileFileInput" accept=".json" style="display: none;"> </div> </fieldset>
            <fieldset> <legend>转换流程 <span class="debug-notice">（根据设置，执行LLM步骤时可能自动下载调试文件）</span></legend> {/* [内容不变] */} <div> <label for="novelText">原始小说原文:</label> <textarea id="novelText" name="novelText" required placeholder="在此粘贴需要处理的原始小说原文..."></textarea> <button type="button" id="preprocessButton">第一步：转换小说格式</button> <span id="step1Status" class="status-indicator"></span> </div> <div class="step-container"> <label for="structuredNovelText">步骤一结果 (格式化文本 - 可编辑):</label> <textarea id="structuredNovelText" name="structuredNovelText" placeholder="步骤一的结果将显示在这里..." style="background-color: #e8f4ff;"></textarea> <input type="text" id="formattedFilename" class="filename-input" placeholder="输入文件名 (无需.txt)"> <button type="button" id="saveFormattedButton" class="secondary" disabled>保存为 TXT</button> <button type="button" id="enhancePromptsButton" disabled>第二步：添加 NAI 提示词</button> <span id="step2Status" class="status-indicator"></span> </div> <div class="step-container"> <label for="enhancedNovelText">步骤二结果 (含 NAI 提示标记 - 可编辑):</label> <textarea id="enhancedNovelText" name="enhancedNovelText" placeholder="步骤二的结果将显示在这里..." style="background-color: #fff8e1;"></textarea> <input type="text" id="enhancedFilename" class="filename-input" placeholder="输入文件名 (无需.txt)"> <button type="button" id="saveEnhancedButton" class="secondary" disabled>保存为 TXT (含提示词)</button> <div class="step3-controls"> <button type="button" id="convertToKagButton" disabled>第三步：转 KAG (生成占位符)</button> <label for="imagePrefixInput" style="margin-top: 10px; margin-left: 10px; font-weight: normal;">图片文件名前缀:</label> <input type="text" id="imagePrefixInput" class="prefix-input" placeholder="例如: chapter1_"> <span id="step3Status" class="status-indicator"></span> </div> </div> <div class="step-container"> <label for="outputKs">步骤三结果 (KAG 脚本 - 可编辑):</label> <textarea id="outputKs" placeholder="最终 KAG 脚本结果将逐步显示在这里..." style="background-color: #e0e0e0;"></textarea> <input type="text" id="ksFilename" class="filename-input" placeholder="输入文件名 (无需.ks)"> <button type="button" id="saveKsButton" class="secondary" disabled>保存为 .ks 文件 (UTF-16LE)</button> <span id="imageReplaceStatus" class="status-indicator" style="font-weight: bold;"></span> <hr style="margin-top: 20px;"> <button type="button" id="generateNaiImagesButton" class="warning" disabled>生成 KAG 脚本中的图片 (使用 NAI API)</button> <span id="naiImageGenStatus" class="status-indicator"></span> </div> </fieldset>
        </form>
    </div>

    <script>
        // --- 获取所有元素 (添加流式选项) ---
        const apiKeyInput = document.getElementById('apiKey'); const apiEndpointInput = document.getElementById('apiEndpoint'); const modelNameInput = document.getElementById('modelName'); const temperatureInput = document.getElementById('temperature'); const maxOutputTokensInput = document.getElementById('maxOutputTokens'); const preInstructionInput = document.getElementById('preInstruction'); const postInstructionInput = document.getElementById('postInstruction'); const successSoundPathInput = document.getElementById('successSoundPath'); const failureSoundPathInput = document.getElementById('failureSoundPath'); const saveParamsButton = document.getElementById('saveParamsButton'); const loadParamsButton = document.getElementById('loadParamsButton'); const paramStatusSpan = document.getElementById('param-status'); const saveDebugInputsCheckbox = document.getElementById('saveDebugInputsCheckbox'); const enableStreamingCheckbox = document.getElementById('enableStreamingCheckbox'); // 新增流式选项
        const naiApiKeyInput = document.getElementById('naiApiKey'); const naiImageSaveDirInput = document.getElementById('naiImageSaveDir'); const naiModelSelect = document.getElementById('naiModel'); const naiSamplerSelect = document.getElementById('naiSampler'); const naiStepsInput = document.getElementById('naiSteps'); const naiScaleInput = document.getElementById('naiScale'); const naiSeedInput = document.getElementById('naiSeed'); const naiUcPresetSelect = document.getElementById('naiUcPreset'); const naiQualityToggleCheckbox = document.getElementById('naiQualityToggle'); const saveNaiParamsButton = document.getElementById('saveNaiParamsButton'); const naiParamStatusSpan = document.getElementById('nai-param-status'); const generateNaiImagesButton = document.getElementById('generateNaiImagesButton'); const naiImageGenStatusSpan = document.getElementById('naiImageGenStatus'); const loadNaiModelsButton = document.getElementById('loadNaiModelsButton'); const naiModelFileInput = document.getElementById('naiModelFileInput'); const naiModelFileStatusSpan = document.getElementById('naiModelFileStatus');
        const profilesListDiv = document.getElementById('profilesList'); const addProfileButton = document.getElementById('addProfileButton'); const profileStatusSpan = document.getElementById('profile-status'); const loadProfileFileButton = document.getElementById('loadProfileFileButton'); const saveProfileFileButton = document.getElementById('saveProfileFileButton'); const profileFileNameSpan = document.getElementById('profileFileNameSpan'); const profileFileInput = document.getElementById('profileFileInput');
        const novelTextInput = document.getElementById('novelText'); const structuredNovelTextarea = document.getElementById('structuredNovelText'); const formattedFilenameInput = document.getElementById('formattedFilename'); const saveFormattedButton = document.getElementById('saveFormattedButton'); const enhancePromptsButton = document.getElementById('enhancePromptsButton'); const step1StatusSpan = document.getElementById('step1Status'); const enhancedNovelTextarea = document.getElementById('enhancedNovelText'); const enhancedFilenameInput = document.getElementById('enhancedFilename'); const saveEnhancedButton = document.getElementById('saveEnhancedButton'); const convertToKagButton = document.getElementById('convertToKagButton'); const step2StatusSpan = document.getElementById('step2Status'); const imagePrefixInput = document.getElementById('imagePrefixInput'); const outputKsTextarea = document.getElementById('outputKs'); const ksFilenameInput = document.getElementById('ksFilename'); const saveKsButton = document.getElementById('saveKsButton'); const step3StatusSpan = document.getElementById('step3Status'); const imageReplaceStatusSpan = document.getElementById('imageReplaceStatus'); const preprocessButton = document.getElementById('preprocessButton');

        // --- 全局变量 ---
        let characterProfiles = {};
        let sseBuffer = '';
        let availableNaiModels = [];

        // --- Helper 函数 ---
        function parseSSE(chunk) { /* [保持不变] */ const messages = []; sseBuffer += chunk; const parts = sseBuffer.split('\n\n'); sseBuffer = parts.pop() || ''; for (const part of parts) { if (!part.trim()) continue; const lines = part.split('\n'); let eventData = ''; let eventType = 'message'; for (const line of lines) { if (line.startsWith('event:')) { eventType = line.substring(6).trim(); } else if (line.startsWith('data:')) { eventData += line.substring(5).trim() + '\n'; } } eventData = eventData.trim(); if (eventData) { try { const jsonData = JSON.parse(eventData); messages.push({ type: eventType, data: jsonData }); } catch (e) { console.error("Failed to parse SSE JSON data:", eventData, e); messages.push({ type: 'error', data: { message: "Received invalid JSON data: " + eventData.substring(0, 50) + "..." } }); } } } return messages; }
        function showNotification(title, body) { /* [保持不变] */ if (!("Notification" in window)) { return; } if (Notification.permission === "granted") { new Notification(title, { body: body, icon: '/favicon.ico' }); } else if (Notification.permission !== "denied") { Notification.requestPermission().then((permission) => { if (permission === "granted") { new Notification(title, { body: body, icon: '/favicon.ico' }); } }); } }
        async function triggerSoundPlayback(isSuccess) { /* [保持不变] */ const status = isSuccess ? "success" : "failure"; try { const response = await fetch('/play_sound', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: status }) }); if (!response.ok) {/* Ignore */} } catch (error) {/* Ignore */} }
        function saveDebugInput(stepName, data) { /* [保持不变] */ console.log(`Saving debug input for ${stepName}`); let content = `--- DEBUG INPUTS for ${stepName} ---\n\n`; content += `Timestamp: ${new Date().toISOString()}\n\n`; content += `--- API PARAMS (Sent from Frontend) ---\n`; content += `Endpoint: ${data.api_base_url || 'N/A'}\n`; content += `Model: ${data.model_name || 'N/A'}\n`; content += `Temperature: ${data.temperature !== null && data.temperature !== undefined ? data.temperature : 'Default'}\n`; content += `Max Tokens: ${data.max_output_tokens !== null && data.max_output_tokens !== undefined ? data.max_output_tokens : 'Default'}\n\n`; content += `--- PRE-INSTRUCTION ---\n${data.pre_instruction || '(None)'}\n\n`; if (stepName.includes("步骤一")) { content += `--- RAW NOVEL TEXT ---\n${data.novel_text || '(None)'}\n\n`; } else if (stepName.includes("步骤二")) { content += `--- FORMATTED TEXT ---\n${data.formatted_text || '(None)'}\n\n`; content += `--- CHARACTER PROFILES (JSON String) ---\n${data.character_profiles_json || '(None)'}\n\n`; } else if (stepName.includes("步骤三")) { content += `--- ENHANCED TEXT ---\n${data.enhanced_text || '(None)'}\n\n`; const prefix = imagePrefixInput ? imagePrefixInput.value.trim() : '(Not Set)'; content += `--- Image Prefix (Frontend Setting) ---\n${prefix}\n\n`; } content += `--- POST-INSTRUCTION ---\n${data.post_instruction || '(None)'}\n\n`; content += `--- END OF DEBUG INPUTS ---`; const safeStepName = stepName.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_'); const filename = `debug_inputs_${safeStepName}_${Date.now()}.txt`; try { const blob = new Blob([content], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = filename; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a); console.log(`Debug input file saved as ${filename}`); } catch (e) { console.error(`Failed to save debug input file ${filename}:`, e); alert(`自动保存调试文件 ${filename} 失败。`); } }
        function updateAllButtonStates() { /* [保持不变] */ try { const novelTextAvailable = novelTextInput && novelTextInput.value.trim() !== ''; const step1OutputAvailable = structuredNovelTextarea && structuredNovelTextarea.value.trim() !== ''; const step2OutputAvailable = enhancedNovelTextarea && enhancedNovelTextarea.value.trim() !== ''; const step3OutputAvailable = outputKsTextarea && outputKsTextarea.value.trim() !== ''; const profilesExist = Object.keys(characterProfiles).length > 0 || (profilesListDiv && profilesListDiv.querySelectorAll('.profile-entry').length > 0); const naiConfigReady = naiApiKeyInput && naiApiKeyInput.value.trim() !== '' && naiImageSaveDirInput && naiImageSaveDirInput.value.trim() !== ''; if (preprocessButton) preprocessButton.disabled = !novelTextAvailable; if (enhancePromptsButton) enhancePromptsButton.disabled = !step1OutputAvailable; if (convertToKagButton) convertToKagButton.disabled = !step2OutputAvailable; if (saveFormattedButton) saveFormattedButton.disabled = !step1OutputAvailable; if (saveEnhancedButton) saveEnhancedButton.disabled = !step2OutputAvailable; if (saveKsButton) saveKsButton.disabled = !step3OutputAvailable; if (saveProfileFileButton) saveProfileFileButton.disabled = !profilesExist; if (generateNaiImagesButton) generateNaiImagesButton.disabled = !(step3OutputAvailable && naiConfigReady); } catch (e) { console.error("Error in updateAllButtonStates:", e); } }
        function replaceImagePlaceholders(kagScript, prefix) { /* [保持不变] */ console.log("Attempting to replace image placeholders..."); if (imageReplaceStatusSpan) { imageReplaceStatusSpan.textContent = "正在替换图片占位符..."; imageReplaceStatusSpan.style.color = "#669"; } if (!kagScript) { console.warn("No KAG script content to process."); if(imageReplaceStatusSpan) imageReplaceStatusSpan.textContent = "无内容可替换"; return ""; } const placeholderRegex = /\[INSERT_IMAGE_HERE:([^\]]+?)\]/g; const characterImageCounters = {}; let replacementsMade = 0; const processedScript = kagScript.replace(placeholderRegex, (match, characterName) => { const sanitizedName = characterName.trim().replace(/[^a-zA-Z0-9_\-\u4e00-\u9fa5]/g, '_'); if (!sanitizedName) { console.warn("Found placeholder with invalid name:", match); return match; } characterImageCounters[sanitizedName] = (characterImageCounters[sanitizedName] || 0) + 1; const index = characterImageCounters[sanitizedName]; const filename = `${prefix}${sanitizedName}_${index}.png`; const kagTag = `[image storage="${filename}" layer=0 page=fore visible=true width=1024 height=1024]\n[p]`; replacementsMade++; console.log(`Replacing "${match}" with KAG tag for "${filename}"`); return kagTag; }); if (imageReplaceStatusSpan) { if (replacementsMade > 0) { console.log(`Replaced ${replacementsMade} placeholders.`); imageReplaceStatusSpan.textContent = `已替换 ${replacementsMade} 个图片标签。`; imageReplaceStatusSpan.style.color = "green"; } else { console.log("No placeholders found."); imageReplaceStatusSpan.textContent = "未找到可替换的占位符。"; imageReplaceStatusSpan.style.color = "#555"; } setTimeout(() => { imageReplaceStatusSpan.textContent = ""; }, 5000); } return processedScript; }

        // --- 流式处理函数 ---
        async function processStream(targetTextarea, statusSpan, endpoint, payload, stepName, isKagConversion = false) { /* [保持不变] */ if (!targetTextarea || !statusSpan) { console.error(`processStream Error: target elements not found for step: ${stepName}`); return; } targetTextarea.value = ''; statusSpan.textContent = '正在初始化...'; statusSpan.className = 'status-indicator'; sseBuffer = ''; if (isKagConversion && imageReplaceStatusSpan) { imageReplaceStatusSpan.textContent = ''; } if(preprocessButton) preprocessButton.disabled = true; if(saveFormattedButton) saveFormattedButton.disabled = true; if(enhancePromptsButton) enhancePromptsButton.disabled = true; if(saveEnhancedButton) saveEnhancedButton.disabled = true; if(convertToKagButton) convertToKagButton.disabled = true; if(saveKsButton) saveKsButton.disabled = true; if(generateNaiImagesButton) generateNaiImagesButton.disabled = true; let finalStatus = "unknown"; let accumulatedContent = ""; try { statusSpan.textContent = '发送请求 (流式)...'; console.log(`Sending stream request to ${endpoint} for ${stepName}`); const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { let errorMsg = `后端错误 (${response.status})`; let errorDetails = ""; try { const errorJson = await response.json(); errorDetails = errorJson.error || errorJson.message || JSON.stringify(errorJson); } catch (e) { try { errorDetails = await response.text(); } catch (e2) { errorDetails = response.statusText; } } errorMsg += `: ${errorDetails}`; console.error(`Error response from ${endpoint}: ${errorMsg}`); throw new Error(errorMsg); } if (!response.body) { throw new Error('响应体为空'); } statusSpan.textContent = '接收数据 (流式)...'; const reader = response.body.getReader(); const decoder = new TextDecoder("utf-8"); finalStatus = "success"; while (true) { const { value, done } = await reader.read(); if (done) { console.log(`${stepName} stream finished.`); statusSpan.textContent = '处理完成!'; break; } const decodedChunk = decoder.decode(value, { stream: true }); const messages = parseSSE(decodedChunk); if (messages && messages.length > 0) { for (const message of messages) { if (message.type === 'error' || (message.data && message.data.type === 'error')) { const errorText = message.data.message || (message.data.raw ? JSON.stringify(message.data.raw) : "未知流错误"); console.error(`Stream Error (${stepName}):`, errorText); statusSpan.textContent = `错误: ${errorText}`; statusSpan.className = 'status-indicator error'; finalStatus = "error"; try { await reader.cancel(); } catch(cancelError) { console.warn("Error cancelling reader:", cancelError); } updateAllButtonStates(); return; } else if (message.type === 'warning' || (message.data && message.data.type === 'warning')) { const warnText = message.data.message || "未知警告"; console.warn(`Stream Warning (${stepName}): ${warnText}`); } else if (message.data && message.data.type === 'chunk') { const content = message.data.content; console.log(`[SSE Chunk Received (${stepName})]:`, JSON.stringify(content)); targetTextarea.value += content; accumulatedContent += content; targetTextarea.scrollTop = targetTextarea.scrollHeight; } else if (message.data && (message.data.type === 'header' || message.data.type === 'footer')) { console.log(`${stepName} received ${message.data.type}: ${message.data.content.trim()}`); } else { console.warn(`Received unknown message structure (${stepName}):`, message); } } } } } catch (error) { console.error(`Stream Error (${stepName} - ${endpoint}):`, error); statusSpan.textContent = `失败: ${error.message}`; statusSpan.className = 'status-indicator error'; finalStatus = "error"; } finally { const isSuccess = finalStatus === "success"; if (isSuccess) { if (isKagConversion) { const imagePrefix = imagePrefixInput ? imagePrefixInput.value.trim() : ""; targetTextarea.value = replaceImagePlaceholders(accumulatedContent, imagePrefix); } showNotification(`${stepName} 完成`, "处理已成功结束。"); triggerSoundPlayback(true); } else { showNotification(`${stepName} 失败`, `处理过程中发生错误: ${statusSpan.textContent}`); triggerSoundPlayback(false); } updateAllButtonStates(); } }

        // --- 新增：非流式处理函数 ---
        async function processNonStream(targetTextarea, statusSpan, endpoint, payload, stepName, isKagConversion = false) {
            if (!targetTextarea || !statusSpan) { console.error(`processNonStream Error: target elements not found for step: ${stepName}`); return; }
            targetTextarea.value = ''; statusSpan.textContent = '正在初始化...'; statusSpan.className = 'status-indicator';
            if (isKagConversion && imageReplaceStatusSpan) { imageReplaceStatusSpan.textContent = ''; }
            // Disable buttons
            if(preprocessButton) preprocessButton.disabled = true; if(saveFormattedButton) saveFormattedButton.disabled = true; if(enhancePromptsButton) enhancePromptsButton.disabled = true; if(saveEnhancedButton) saveEnhancedButton.disabled = true; if(convertToKagButton) convertToKagButton.disabled = true; if(saveKsButton) saveKsButton.disabled = true; if(generateNaiImagesButton) generateNaiImagesButton.disabled = true;
            let finalStatus = "unknown";

            try {
                statusSpan.textContent = '发送请求 (非流式)...';
                console.log(`Sending non-stream request to ${endpoint} for ${stepName}`);
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json(); // Wait for the full JSON response

                if (response.ok && result.status === "success") {
                    console.log(`${stepName} non-stream call successful.`);
                    statusSpan.textContent = '处理完成!';
                    let fullResult = result.result || "";

                    // Post-processing for KAG step (placeholder replacement)
                    if (isKagConversion) {
                        const imagePrefix = imagePrefixInput ? imagePrefixInput.value.trim() : "";
                        fullResult = replaceImagePlaceholders(fullResult, imagePrefix);
                    }

                    targetTextarea.value = fullResult;
                    targetTextarea.scrollTop = targetTextarea.scrollHeight;
                    finalStatus = "success";

                } else {
                    // Handle errors reported in the JSON body or HTTP errors
                    const errorMsg = result.error || `后端错误 (${response.status})`;
                    console.error(`Non-Stream Error (${stepName} - ${endpoint}): ${errorMsg}`);
                    throw new Error(errorMsg);
                }

            } catch (error) {
                console.error(`Non-Stream Error (${stepName} - ${endpoint}):`, error);
                statusSpan.textContent = `失败: ${error.message}`;
                statusSpan.className = 'status-indicator error';
                finalStatus = "error";
            } finally {
                const isSuccess = finalStatus === "success";
                if (isSuccess) {
                    showNotification(`${stepName} 完成`, "处理已成功结束 (非流式)。");
                    triggerSoundPlayback(true);
                } else {
                    showNotification(`${stepName} 失败`, `处理过程中发生错误: ${statusSpan.textContent}`);
                    triggerSoundPlayback(false);
                }
                updateAllButtonStates(); // Re-enable buttons
            }
        }


        // --- API 参数管理 (添加流式选项) ---
        async function saveAllParameters() {
             console.log("saveAllParameters called"); paramStatusSpan.textContent = "正在保存所有设置..."; paramStatusSpan.style.color = "#669"; if(naiParamStatusSpan) naiParamStatusSpan.textContent = "";
             const paramsToSave = {
                 apiKey: apiKeyInput ? apiKeyInput.value.trim() : '', apiEndpoint: apiEndpointInput ? apiEndpointInput.value.trim() : '', modelName: modelNameInput ? modelNameInput.value.trim() : '', temperature: temperatureInput && temperatureInput.value !== '' ? parseFloat(temperatureInput.value) : null, maxOutputTokens: maxOutputTokensInput && maxOutputTokensInput.value !== '' ? parseInt(maxOutputTokensInput.value, 10) : null, successSoundPath: successSoundPathInput ? successSoundPathInput.value.trim() : '', failureSoundPath: failureSoundPathInput ? failureSoundPathInput.value.trim() : '', preInstruction: preInstructionInput ? preInstructionInput.value.trim() : '', postInstruction: postInstructionInput ? postInstructionInput.value.trim() : '', saveDebugInputs: saveDebugInputsCheckbox ? saveDebugInputsCheckbox.checked : false,
                 enableStreaming: enableStreamingCheckbox ? enableStreamingCheckbox.checked : true, // 保存流式选项
                 naiApiKey: naiApiKeyInput ? naiApiKeyInput.value.trim() : '', naiImageSaveDir: naiImageSaveDirInput ? naiImageSaveDirInput.value.trim() : '', naiModel: naiModelSelect ? naiModelSelect.value : '', naiSampler: naiSamplerSelect ? naiSamplerSelect.value : 'k_euler', naiSteps: naiStepsInput && naiStepsInput.value !== '' ? parseInt(naiStepsInput.value, 10) : 28, naiScale: naiScaleInput && naiScaleInput.value !== '' ? parseFloat(naiScaleInput.value) : 7.0, naiSeed: naiSeedInput && naiSeedInput.value !== '' ? parseInt(naiSeedInput.value, 10) : -1, naiUcPreset: naiUcPresetSelect ? parseInt(naiUcPresetSelect.value, 10) : 0, naiQualityToggle: naiQualityToggleCheckbox ? naiQualityToggleCheckbox.checked : true };
             if (!paramsToSave.apiKey || !paramsToSave.apiEndpoint || !paramsToSave.modelName) { paramStatusSpan.textContent = "错误：LLM API Key, Base URL, Model Name 不能为空。"; paramStatusSpan.style.color = "red"; setTimeout(() => { paramStatusSpan.textContent = ""; }, 4000); return; }
             try { const response = await fetch('/save_config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(paramsToSave) }); const result = await response.json(); if (response.ok) { paramStatusSpan.textContent = result.message || "所有设置已保存。"; paramStatusSpan.style.color = "green"; } else { throw new Error(result.error || `保存失败 (${response.status})`); } } catch (e) { console.error("保存设置失败:", e); paramStatusSpan.textContent = `保存失败: ${e.message}`; paramStatusSpan.style.color = "red"; } finally { setTimeout(() => { paramStatusSpan.textContent = ""; }, 4000); }
        }

        async function loadAllParameters() {
             console.log("loadAllParameters called"); paramStatusSpan.textContent = "正在加载所有设置..."; paramStatusSpan.style.color = "#669"; if(naiParamStatusSpan) naiParamStatusSpan.textContent = ""; try { const response = await fetch('/load_config'); if (!response.ok) { throw new Error(`加载配置请求失败 (${response.status})`); } const configData = await response.json(); if (configData.error) { throw new Error(configData.error); } let loaded = false; if (typeof configData === 'object' && configData !== null) { if(apiKeyInput) apiKeyInput.value = configData.apiKey || ''; if(apiEndpointInput) apiEndpointInput.value = configData.apiEndpoint || ''; if(modelNameInput) modelNameInput.value = configData.modelName || ''; if(temperatureInput) temperatureInput.value = (configData.temperature !== null && configData.temperature !== undefined) ? configData.temperature : ''; if(maxOutputTokensInput) maxOutputTokensInput.value = (configData.maxOutputTokens !== null && configData.maxOutputTokens !== undefined) ? configData.maxOutputTokens : ''; if(successSoundPathInput) successSoundPathInput.value = configData.successSoundPath || ''; if(failureSoundPathInput) failureSoundPathInput.value = configData.failureSoundPath || ''; if(preInstructionInput) preInstructionInput.value = configData.preInstruction || ''; if(postInstructionInput) postInstructionInput.value = configData.postInstruction || ''; if(saveDebugInputsCheckbox) saveDebugInputsCheckbox.checked = configData.saveDebugInputs || false; if(enableStreamingCheckbox) enableStreamingCheckbox.checked = configData.enableStreaming !== undefined ? configData.enableStreaming : true; /* NAI */ if(naiApiKeyInput) naiApiKeyInput.value = configData.naiApiKey || ''; if(naiImageSaveDirInput) naiImageSaveDirInput.value = configData.naiImageSaveDir || ''; const savedNaiModelValue = configData.naiModel || ''; if(naiModelSelect) naiModelSelect.setAttribute('data-saved-value', savedNaiModelValue); if(naiSamplerSelect) naiSamplerSelect.value = configData.naiSampler || 'k_euler'; if(naiStepsInput) naiStepsInput.value = configData.naiSteps !== undefined ? configData.naiSteps : 28; if(naiScaleInput) naiScaleInput.value = configData.naiScale !== undefined ? configData.naiScale : 7.0; if(naiSeedInput) naiSeedInput.value = configData.naiSeed !== undefined ? configData.naiSeed : -1; if(naiUcPresetSelect) naiUcPresetSelect.value = configData.naiUcPreset !== undefined ? configData.naiUcPreset : 0; if(naiQualityToggleCheckbox) naiQualityToggleCheckbox.checked = configData.naiQualityToggle !== undefined ? configData.naiQualityToggle : true; if (configData.apiKey || configData.apiEndpoint || configData.modelName) { loaded = true; } } if (loaded) { paramStatusSpan.textContent = "已加载所有设置。"; paramStatusSpan.style.color = "blue"; } else { paramStatusSpan.textContent = "未找到或无有效设置参数。"; paramStatusSpan.style.color = "#666"; } } catch (e) { console.error("加载设置失败:", e); paramStatusSpan.textContent = `加载失败: ${e.message}`; paramStatusSpan.style.color = "red"; } finally { setTimeout(() => { paramStatusSpan.textContent = ""; }, 4000); updateAllButtonStates(); }
        }
        function saveTextToFile(textareaElement, defaultFilename, extension, encoding = 'utf-8') { /* [保持不变] */ if (!textareaElement || !textareaElement.value.trim()) { alert("没有可保存的内容。"); return; } const content = textareaElement.value; let filenameInputId = ''; if (textareaElement.id === 'structuredNovelText') filenameInputId = 'formattedFilename'; else if (textareaElement.id === 'enhancedNovelText') filenameInputId = 'enhancedFilename'; else if (textareaElement.id === 'outputKs') filenameInputId = 'ksFilename'; let filename = defaultFilename; const filenameInputElement = filenameInputId ? document.getElementById(filenameInputId) : null; if (filenameInputElement && filenameInputElement.value.trim()) { filename = filenameInputElement.value.trim().replace(/[\\/:*?"<>|]/g, '_'); } else { filename = defaultFilename.replace(/[\\/:*?"<>|]/g, '_'); } filename += extension; try { let dataToSave = content; if (encoding === 'utf-16le') { const bom = "\uFEFF"; dataToSave = bom + content; } const blob = new Blob([dataToSave], { type: `application/octet-stream;charset=${encoding}` }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = filename; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a); } catch (e) { console.error(`保存 ${extension} 文件失败:`, e); alert(`保存 ${extension} 文件 (${filename}) 失败。请尝试手动复制内容并使用文本编辑器保存 (编码: ${encoding})。`); } }
        function saveFormattedText() { saveTextToFile(structuredNovelTextarea, 'formatted_novel', '.txt'); } function saveEnhancedText() { saveTextToFile(enhancedNovelTextarea, 'enhanced_novel', '.txt'); } function saveKsFile() { saveTextToFile(outputKsTextarea, 'generated_script', '.ks', 'utf-16le'); }
        function renderProfilesList() { /* [保持不变] */ console.log("renderProfilesList called"); if (!profilesListDiv) { console.error("profilesListDiv not found!"); return; } profilesListDiv.innerHTML = ''; if (typeof characterProfiles !== 'object' || characterProfiles === null) { characterProfiles = {}; } const names = Object.keys(characterProfiles).sort(); if (names.length === 0) { profilesListDiv.innerHTML = '<p style="font-style: italic; color: #888;">请加载或添加人物设定。</p>'; } else { names.forEach(name => { const profile = characterProfiles[name]; if (typeof profile !== 'object' || profile === null) { console.warn(`Skipping invalid profile: ${name}`); return; } const entryDiv = document.createElement('div'); entryDiv.className = 'profile-entry'; const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.dataset.type = 'name'; nameInput.value = name; nameInput.placeholder = '人物名称'; nameInput.title = name; const posInput = document.createElement('input'); posInput.type = 'text'; posInput.dataset.type = 'positive'; posInput.value = profile.positive || ''; posInput.placeholder = '正面提示词'; posInput.title = profile.positive || ''; const negInput = document.createElement('input'); negInput.type = 'text'; negInput.dataset.type = 'negative'; negInput.value = profile.negative || ''; negInput.placeholder = '负面提示词'; negInput.title = profile.negative || ''; const removeButton = document.createElement('button'); removeButton.type = 'button'; removeButton.className = 'remove-profile-button'; removeButton.dataset.name = name; removeButton.textContent = '删除'; removeButton.addEventListener('click', handleRemoveProfile); entryDiv.appendChild(nameInput); entryDiv.appendChild(posInput); entryDiv.appendChild(negInput); entryDiv.appendChild(removeButton); profilesListDiv.appendChild(entryDiv); }); } updateAllButtonStates(); }
        function handleAddProfile() { /* [保持不变] */ console.log("handleAddProfile called"); const newName = prompt("请输入新人物名称：", ""); if (newName && newName.trim()) { const trimmedName = newName.trim(); if (!characterProfiles[trimmedName]) { characterProfiles[trimmedName] = { positive: "", negative: "" }; renderProfilesList(); profilesListDiv.scrollTop = profilesListDiv.scrollHeight; const newInput = profilesListDiv.querySelector(`.profile-entry input[data-type="name"][value="${trimmedName}"]`); if(newInput) { newInput.focus(); } if(profileStatusSpan){ profileStatusSpan.textContent = `已添加 "${trimmedName}" (点击保存生效)`; profileStatusSpan.style.color = '#666'; setTimeout(() => { profileStatusSpan.textContent = ""; }, 3000); } } else { alert(`人物 "${trimmedName}" 已存在！`); } } }
        function handleRemoveProfile(event) { /* [保持不变] */ console.log("handleRemoveProfile called for", event.target.dataset.name); const nameToRemove = event.target.dataset.name; if (nameToRemove && characterProfiles[nameToRemove]) { if (confirm(`确定删除人物 "${nameToRemove}"?`)) { delete characterProfiles[nameToRemove]; renderProfilesList(); if(profileStatusSpan){ profileStatusSpan.textContent = `人物 "${nameToRemove}" 已移除 (点击保存生效)`; profileStatusSpan.style.color = '#666'; setTimeout(() => { profileStatusSpan.textContent = ""; }, 3000); } } } }
        function handleLoadProfileFileClick() { /* [保持不变] */ if (profileFileInput) profileFileInput.click(); }
        function loadProfileFromFile(event) { /* [保持不变] */ const file = event.target.files[0]; if (!file) { return; } const reader = new FileReader(); reader.onload = (e) => { try { const content = e.target.result; const loadedData = JSON.parse(content); if (typeof loadedData === 'object' && loadedData !== null) { characterProfiles = loadedData; renderProfilesList(); if(profileFileNameSpan) { profileFileNameSpan.textContent = `已加载: ${file.name}`; profileFileNameSpan.title = file.name; } if(profileStatusSpan) { profileStatusSpan.textContent = "设定加载成功！"; profileStatusSpan.style.color = 'green'; } } else { throw new Error("文件内容不是有效的 JSON 对象。"); } } catch (err) { console.error("加载设定文件失败:", err); alert(`加载设定文件失败: ${err.message}`); if(profileStatusSpan) { profileStatusSpan.textContent = "加载失败！"; profileStatusSpan.style.color = 'red'; } if(profileFileNameSpan) { profileFileNameSpan.textContent = "加载失败"; profileFileNameSpan.title = ""; } } finally { if(profileFileInput) profileFileInput.value = null; if(profileStatusSpan) { setTimeout(() => { profileStatusSpan.textContent = ""; }, 4000); } updateAllButtonStates(); } }; reader.onerror = (e) => { console.error("读取文件出错:", e); alert("读取文件出错。"); if(profileStatusSpan) { profileStatusSpan.textContent = "读取出错！"; profileStatusSpan.style.color = 'red'; setTimeout(() => { profileStatusSpan.textContent = ""; }, 4000); } if(profileFileNameSpan) { profileFileNameSpan.textContent = "读取错误"; profileFileNameSpan.title = ""; } if(profileFileInput) profileFileInput.value = null; }; reader.readAsText(file); }
        function handleSaveProfileFileClick() { /* [保持不变] */ const currentProfiles = {}; const entries = profilesListDiv ? profilesListDiv.querySelectorAll('.profile-entry') : []; let valid = true; entries.forEach(entry => { const nameInput = entry.querySelector('input[data-type="name"]'); const posInput = entry.querySelector('input[data-type="positive"]'); const negInput = entry.querySelector('input[data-type="negative"]'); if (!nameInput || !posInput || !negInput) { valid = false; return; } const name = nameInput.value.trim(); if (name) { currentProfiles[name] = { positive: posInput.value.trim(), negative: negInput.value.trim() }; nameInput.style.borderColor = ''; } else { nameInput.style.borderColor = 'red'; valid = false; } }); if (!valid) { alert("错误：人物名称不能为空！"); return; } if (Object.keys(currentProfiles).length === 0) { alert("没有可保存的设定。"); return; } const jsonString = JSON.stringify(currentProfiles, null, 2); const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = 'character_profiles.json'; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a); if(profileStatusSpan) { profileStatusSpan.textContent = "设定已导出，请保存文件。"; profileStatusSpan.style.color = 'blue'; setTimeout(() => { profileStatusSpan.textContent = ""; }, 4000); } characterProfiles = currentProfiles; }
        function handleLoadNaiModelsClick() { if (naiModelFileInput) naiModelFileInput.click(); }
        function loadNaiModelsFromFile(event) { /* [保持不变 - 使用修正后的版本] */ const file = event.target.files[0]; if (!file) { return; } const reader = new FileReader(); reader.onload = (e) => { let statusSpan = naiModelFileStatusSpan; try { const content = e.target.result; const loadedModels = JSON.parse(content); if (!Array.isArray(loadedModels) || !loadedModels.every(m => typeof m === 'object' && m !== null && 'name' in m && 'value' in m)) { throw new Error("文件格式错误: 期望是 [{name: '...', value: '...'}, ...]"); } availableNaiModels = loadedModels; if (naiModelSelect) { const currentSelectedValue = naiModelSelect.value; naiModelSelect.innerHTML = ''; availableNaiModels.forEach(model => { const option = document.createElement('option'); option.value = model.value; option.textContent = model.name; naiModelSelect.appendChild(option); }); if (currentSelectedValue && naiModelSelect.querySelector(`option[value="${currentSelectedValue}"]`)) { naiModelSelect.value = currentSelectedValue; } else if (naiModelSelect.options.length > 0) { naiModelSelect.selectedIndex = 0; } } if (statusSpan) { statusSpan.textContent = `已加载: ${file.name}`; statusSpan.title = file.name; statusSpan.style.color = 'green'; } } catch (err) { console.error("加载 NAI 模型文件失败:", err); alert(`加载模型文件失败: ${err.message}`); if (statusSpan) { statusSpan.textContent = "加载失败"; statusSpan.title = ""; statusSpan.style.color = 'red'; } if (naiModelSelect) { naiModelSelect.innerHTML = '<option value="">-- 加载失败 --</option>'; } } finally { if (naiModelFileInput) naiModelFileInput.value = null; if (statusSpan) { setTimeout(() => { statusSpan.textContent = "未加载模型文件"; statusSpan.style.color="#555"; }, 4000); } updateAllButtonStates(); } }; reader.onerror = (e) => { console.error("读取 NAI 模型文件出错:", e); alert("读取文件出错。"); if (naiModelFileStatusSpan) { naiModelFileStatusSpan.textContent = "读取错误"; naiModelFileStatusSpan.title = ""; naiModelFileStatusSpan.style.color = 'red'; setTimeout(() => { naiModelFileStatusSpan.textContent = "未加载模型文件"; naiModelFileStatusSpan.style.color="#555"; }, 4000); } if (naiModelFileInput) naiModelFileInput.value = null; if (naiModelSelect) { naiModelSelect.innerHTML = '<option value="">-- 读取错误 --</option>'; } }; reader.readAsText(file); }

        // --- 页面加载与事件绑定 (*** 修改按钮逻辑以支持流式/非流式选择 ***) ---
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM fully loaded and parsed. Initializing...");
             // --- 验证元素存在性 ---
             let elementsVerified = true;
             const requiredElementIDs = [ /* [保持不变] */ 'apiKey', 'apiEndpoint', 'modelName', 'temperature', 'maxOutputTokens', 'preInstruction', 'postInstruction', 'successSoundPath', 'failureSoundPath', 'saveParamsButton', 'loadParamsButton', 'param-status', 'saveDebugInputsCheckbox', 'enableStreamingCheckbox', 'naiApiKey', 'naiImageSaveDir', 'naiModel', 'naiSampler', 'naiSteps', 'naiScale', 'naiSeed', 'naiUcPreset', 'naiQualityToggle', 'saveNaiParamsButton', 'nai-param-status', 'generateNaiImagesButton', 'naiImageGenStatus', 'loadNaiModelsButton', 'naiModelFileInput', 'naiModelFileStatus', 'profilesList', 'addProfileButton', 'profile-status', 'loadProfileFileButton', 'saveProfileFileButton', 'profileFileNameSpan', 'profileFileInput', 'novelText', 'structuredNovelText', 'formattedFilename', 'saveFormattedButton', 'enhancePromptsButton', 'step1Status', 'enhancedNovelText', 'enhancedFilename', 'saveEnhancedButton', 'convertToKagButton', 'step2Status', 'imagePrefixInput', 'outputKs', 'ksFilename', 'saveKsButton', 'step3Status', 'imageReplaceStatus', 'preprocessButton' ];
             const elements = {}; requiredElementIDs.forEach(id => { elements[id] = document.getElementById(id); if (!elements[id]) { console.error(`Initialization Error: Element with ID '${id}' not found!`); elementsVerified = false; } });
             if (!elementsVerified) { alert("页面初始化错误：缺少必要的 HTML 元素！请检查控制台。"); return; }
             console.log("All required elements verified successfully.");

             try { if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") { Notification.requestPermission(); } } catch (e) { console.error("Error requesting notification permission:", e); }
             try { loadAllParameters(); renderProfilesList(); } catch (e) { console.error("Error loading initial data:", e); }

             try { // --- 绑定事件监听器 ---
                 elements.saveParamsButton.addEventListener('click', saveAllParameters); elements.loadParamsButton.addEventListener('click', loadAllParameters); elements.saveNaiParamsButton.addEventListener('click', saveAllParameters); elements.loadNaiModelsButton.addEventListener('click', handleLoadNaiModelsClick); elements.naiModelFileInput.addEventListener('change', loadNaiModelsFromFile);
                 elements.addProfileButton.addEventListener('click', handleAddProfile); elements.loadProfileFileButton.addEventListener('click', handleLoadProfileFileClick); elements.saveProfileFileButton.addEventListener('click', handleSaveProfileFileClick); elements.profileFileInput.addEventListener('change', loadProfileFromFile);
                 elements.saveFormattedButton.addEventListener('click', saveFormattedText); elements.saveEnhancedButton.addEventListener('click', saveEnhancedText); elements.saveKsButton.addEventListener('click', saveKsFile);

                 // --- 修改步骤按钮逻辑 ---
                 elements.preprocessButton.addEventListener('click', async () => {
                     if(!elements.structuredNovelText || !elements.enhancedNovelText || !elements.outputKs || !elements.step1Status || !elements.step2Status || !elements.step3Status || !elements.imageReplaceStatus) return;
                     elements.structuredNovelText.value = ''; elements.enhancedNovelText.value = ''; elements.outputKs.value = ''; updateAllButtonStates(); elements.step1Status.textContent = ''; elements.step1Status.className = 'status-indicator'; elements.step2Status.textContent = ''; elements.step2Status.className = 'status-indicator'; elements.step3Status.textContent = ''; elements.step3Status.className = 'status-indicator'; elements.imageReplaceStatus.textContent = '';
                     const apiKey = elements.apiKey.value.trim(); const apiBaseUrl = elements.apiEndpoint.value.trim().replace(/\/+$/, ''); const modelName = elements.modelName.value.trim(); let temperature = parseFloat(elements.temperature.value); if (isNaN(temperature) || temperature < 0 || temperature > 2) temperature = null; let maxOutputTokens = parseInt(elements.maxOutputTokens.value, 10); if (isNaN(maxOutputTokens) || maxOutputTokens < 1) maxOutputTokens = null; const novelText = elements.novelText.value.trim(); const preInstruction = elements.preInstruction.value.trim(); const postInstruction = elements.postInstruction.value.trim();
                     if (!apiKey || !apiBaseUrl || !modelName || !novelText) { if(elements.step1Status) { elements.step1Status.textContent = '错误：API 配置和原文不能为空！'; elements.step1Status.className = 'status-indicator error'; } updateAllButtonStates(); return; }
                     const payload = { api_base_url: apiBaseUrl, model_name: modelName, api_key: apiKey, temperature: temperature, max_output_tokens: maxOutputTokens, novel_text: novelText, pre_instruction: preInstruction, post_instruction: postInstruction };
                     if (elements.saveDebugInputsCheckbox && elements.saveDebugInputsCheckbox.checked) { saveDebugInput("步骤一(格式化)", payload); }

                     // *** 根据复选框选择调用哪个 API ***
                     if (elements.enableStreamingCheckbox && elements.enableStreamingCheckbox.checked) {
                         await processStream(elements.structuredNovelText, elements.step1Status, '/preprocess_stream', payload, "步骤一 (格式化)");
                     } else {
                         await processNonStream(elements.structuredNovelText, elements.step1Status, '/preprocess_nostream', payload, "步骤一 (格式化)");
                     }
                 });

                 elements.enhancePromptsButton.addEventListener('click', async () => {
                      if(!elements.enhancedNovelText || !elements.outputKs || !elements.step2Status || !elements.step3Status || !elements.imageReplaceStatus) return;
                      elements.enhancedNovelText.value = ''; elements.outputKs.value = ''; updateAllButtonStates(); elements.step2Status.textContent = ''; elements.step2Status.className = 'status-indicator'; elements.step3Status.textContent = ''; elements.step3Status.className = 'status-indicator'; elements.imageReplaceStatus.textContent = '';
                      const apiKey = elements.apiKey.value.trim(); const apiBaseUrl = elements.apiEndpoint.value.trim().replace(/\/+$/, ''); const modelName = elements.modelName.value.trim(); let temperature = parseFloat(elements.temperature.value); if (isNaN(temperature) || temperature < 0 || temperature > 2) temperature = null; let maxOutputTokens = parseInt(elements.maxOutputTokens.value, 10); if (isNaN(maxOutputTokens) || maxOutputTokens < 1) maxOutputTokens = null; const formattedText = elements.structuredNovelText.value.trim(); const preInstruction = elements.preInstruction.value.trim(); const postInstruction = elements.postInstruction.value.trim();
                      const currentProfiles = {}; const entries = elements.profilesList ? elements.profilesList.querySelectorAll('.profile-entry') : []; let profilesValid = true; entries.forEach(entry => { const nameInput = entry.querySelector('input[data-type="name"]'); const posInput = entry.querySelector('input[data-type="positive"]'); const negInput = entry.querySelector('input[data-type="negative"]'); const name = nameInput.value.trim(); if (name) { currentProfiles[name] = { positive: posInput.value.trim(), negative: negInput.value.trim() }; nameInput.style.borderColor = ''; } else { nameInput.style.borderColor = 'red'; profilesValid = false; } }); if (!profilesValid) { if(elements.step2Status){ elements.step2Status.textContent = '错误：人物设定名称不能为空！'; elements.step2Status.className = 'status-indicator error'; } updateAllButtonStates(); return; } if (Object.keys(currentProfiles).length === 0) { if (!confirm("警告：无人物设定，确定继续？")) { updateAllButtonStates(); return; } } const characterProfilesJson = JSON.stringify(currentProfiles);
                      if (!apiKey || !apiBaseUrl || !modelName || !formattedText) { if(elements.step2Status){ elements.step2Status.textContent = '错误：API 配置和步骤一结果不能为空！'; elements.step2Status.className = 'status-indicator error'; } updateAllButtonStates(); return; }
                      const payload = { api_base_url: apiBaseUrl, model_name: modelName, api_key: apiKey, temperature: temperature, max_output_tokens: maxOutputTokens, formatted_text: formattedText, character_profiles_json: characterProfilesJson, pre_instruction: preInstruction, post_instruction: postInstruction };
                      if (elements.saveDebugInputsCheckbox && elements.saveDebugInputsCheckbox.checked) { saveDebugInput("步骤二(加提示词)", payload); }

                      // *** 根据复选框选择调用哪个 API ***
                      if (elements.enableStreamingCheckbox && elements.enableStreamingCheckbox.checked) {
                           await processStream(elements.enhancedNovelText, elements.step2Status, '/enhance_stream', payload, "步骤二 (添加提示词)"); // Use renamed stream endpoint
                      } else {
                           await processNonStream(elements.enhancedNovelText, elements.step2Status, '/enhance_nostream', payload, "步骤二 (添加提示词)");
                      }
                 });

                 elements.convertToKagButton.addEventListener('click', async () => {
                      if(!elements.outputKs || !elements.step3Status || !elements.imageReplaceStatus) return;
                      elements.outputKs.value = ''; updateAllButtonStates(); elements.step3Status.textContent = ''; elements.step3Status.className = 'status-indicator'; elements.imageReplaceStatus.textContent = '';
                      const apiKey = elements.apiKey.value.trim(); const apiBaseUrl = elements.apiEndpoint.value.trim().replace(/\/+$/, ''); const modelName = elements.modelName.value.trim(); let temperature = parseFloat(elements.temperature.value); if (isNaN(temperature) || temperature < 0 || temperature > 2) temperature = null; let maxOutputTokens = parseInt(elements.maxOutputTokens.value, 10); if (isNaN(maxOutputTokens) || maxOutputTokens < 1) maxOutputTokens = null; const enhancedText = elements.enhancedNovelText.value.trim(); const preInstruction = elements.preInstruction.value.trim(); const postInstruction = elements.postInstruction.value.trim();
                      if (!apiKey || !apiBaseUrl || !modelName || !enhancedText) { if(elements.step3Status){ elements.step3Status.textContent = '错误：API 配置和步骤二结果不能为空！'; elements.step3Status.className = 'status-indicator error'; } updateAllButtonStates(); return; }
                      const payload = { api_base_url: apiBaseUrl, model_name: modelName, api_key: apiKey, temperature: temperature, max_output_tokens: maxOutputTokens, enhanced_text: enhancedText, pre_instruction: preInstruction, post_instruction: postInstruction };
                      if (elements.saveDebugInputsCheckbox && elements.saveDebugInputsCheckbox.checked) { saveDebugInput("步骤三(转KAG)", payload); }

                      // *** 根据复选框选择调用哪个 API ***
                      if (elements.enableStreamingCheckbox && elements.enableStreamingCheckbox.checked) {
                           await processStream(elements.outputKs, elements.step3Status, '/convert_stream', payload, "步骤三 (转 KAG)", true);
                      } else {
                          await processNonStream(elements.outputKs, elements.step3Status, '/convert_nostream', payload, "步骤三 (转 KAG)", true); // Pass isKagConversion=true for placeholder replacement
                      }
                 });

                 // [NAI 生成按钮监听器不变]
                 elements.generateNaiImagesButton.addEventListener('click', async () => { if (!elements.outputKs || !elements.naiImageGenStatus) return; const kagScript = elements.outputKs.value; if (!kagScript.trim()) { elements.naiImageGenStatus.textContent = "错误：KAG 脚本为空。"; elements.naiImageGenStatus.className = 'status-indicator error'; return; } if (!elements.naiApiKey.value.trim() || !elements.naiImageSaveDir.value.trim()) { elements.naiImageGenStatus.textContent = "错误：请配置 NAI API Key 和保存目录。"; elements.naiImageGenStatus.className = 'status-indicator error'; return; } elements.naiImageGenStatus.textContent = "发送图片生成请求..."; elements.naiImageGenStatus.className = 'status-indicator'; elements.generateNaiImagesButton.disabled = true; try { const response = await fetch('/generate_images', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ kag_script: kagScript }) }); const result = await response.json(); if (response.ok) { elements.naiImageGenStatus.textContent = result.message || "图片生成任务完成。"; elements.naiImageGenStatus.className = 'status-indicator'; if (result.modified_script) { elements.outputKs.value = result.modified_script; console.log("KAG script updated."); } console.log("Image generation details:", result.details); showNotification("图片生成完成", result.message); triggerSoundPlayback(true); } else { throw new Error(result.error || `图片生成失败 (${response.status})`); } } catch (error) { console.error("生成 NAI 图片时出错:", error); elements.naiImageGenStatus.textContent = `错误: ${error.message}`; elements.naiImageGenStatus.className = 'status-indicator error'; showNotification("图片生成失败", error.message); triggerSoundPlayback(false); } finally { elements.generateNaiImagesButton.disabled = false; updateAllButtonStates(); setTimeout(() => { if(elements.naiImageGenStatus) elements.naiImageGenStatus.textContent = ""; }, 8000); } });
                 // [Input listeners 不变]
                 if(elements.novelText) elements.novelText.addEventListener('input', updateAllButtonStates); if(elements.structuredNovelText) elements.structuredNovelText.addEventListener('input', updateAllButtonStates); if(elements.enhancedNovelText) elements.enhancedNovelText.addEventListener('input', updateAllButtonStates); if(elements.outputKs) elements.outputKs.addEventListener('input', updateAllButtonStates); if(elements.naiApiKey) elements.naiApiKey.addEventListener('input', updateAllButtonStates); if(elements.naiImageSaveDir) elements.naiImageSaveDir.addEventListener('input', updateAllButtonStates);

                 console.log("Event listeners attached successfully.");
             } catch (e) { console.error("Error attaching event listeners:", e); alert("页面初始化错误：无法绑定按钮事件！"); }

             updateAllButtonStates();
             console.log("Initial button states set.");
         });
    </script>
</body>
</html>