<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小说转 KAG 脚本 (三步式 + NAI 提示 + 文件设定 + 自定义文件名)</title>
    <style>
        /* Basic Styles */
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1100px; margin: 20px auto; background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="password"], input[type="number"], textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        textarea { min-height: 120px; font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; vertical-align: top; line-height: 1.5; background-color: #fff; resize: vertical; }
        .textarea-small { min-height: 60px; }
        #structuredNovelText { background-color: #e8f4ff; }
        #enhancedNovelText { background-color: #fff8e1; }
        #outputKs { background-color: #f0f0f0; min-height: 200px; color: #444; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; margin-right: 10px; transition: background-color 0.2s ease; }
        button.secondary { background-color: #6c757d; }
        button:hover { background-color: #0056b3; }
        button.secondary:hover { background-color: #5a6268; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; opacity: 0.7; }
        .status-indicator { margin-left: 10px; font-style: italic; font-size: 0.9em; color: #669; min-height: 1.2em; display: inline-block;}
        #param-status { font-size: 0.85em; color: green; margin-top: 5px; min-height: 1em;}
        .error { color: #d9534f; font-weight: bold; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 15px; }
        .config-item { min-width: 0; }
        fieldset { margin-bottom: 25px; border: 1px solid #ddd; padding: 20px; border-radius: 5px; background-color: #fafafa;}
        legend { font-weight: bold; padding: 0 10px; color: #337ab7; font-size: 1.1em;}
        .step-container { margin-top: 25px; padding-top: 20px; border-top: 1px dashed #ccc;}
        h1 { text-align: center; color: #337ab7; margin-bottom: 20px;}
        p { color: #666; font-size: 0.95em; }
        .warning { color:#d9534f; font-weight:bold; border: 1px solid #d9534f; padding: 10px; border-radius: 4px; background-color: #fcf8e3;}
        .sound-path-label { font-size: 0.9em; color: #777; font-weight: normal; margin-top: 0; }
        #characterProfilesArea { border: 1px solid #bee5eb; background-color: #f0fcff; padding: 15px; border-radius: 5px; margin-top: 15px; }
        .profile-entry { display: grid; grid-template-columns: 150px auto auto 60px; gap: 10px; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #ddd;}
        .profile-entry input[type="text"] { margin-top: 0; font-size: 0.95em;}
        .profile-entry button { padding: 3px 8px; font-size: 0.9em; margin: 0; background-color: #dc3545; }
        .profile-entry input[data-type="name"] { font-weight: bold; }
        /* Style for filename inputs */
        .filename-input { width: auto; display: inline-block; margin-right: 10px; max-width: 200px; vertical-align: middle; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>小说章节转 KAG 脚本 (三步式 + NAI 提示 + 文件设定 + 自定义文件名)</h1>
        <p>说明：配置 API -> 步骤一：格式化原文 (结果可编辑/保存TXT) -> (加载/编辑/保存人物设定) -> 步骤二：添加 NAI 提示词 (结果可保存TXT) -> 步骤三：转 KAG (结果可保存为 .ks UTF-16LE)。可在保存时输入文件名。可保存/加载 API 参数和人物设定文件。完成后会有通知和声音提示。</p>
        <p class="warning">警告：API Key 和声音文件路径会保存在服务器端的 `config.json` 文件中。人物设定通过加载/保存本地 `.json` 文件进行管理。</p>

        <form id="conversionForm" onsubmit="return false;">
            <fieldset>
                <legend>API 配置</legend>
                 <div class="config-grid">
                    <div class="config-item"> <label for="apiKey">LLM API Key:</label> <input type="password" id="apiKey" name="apiKey" required> </div>
                    <div class="config-item"> <label for="apiEndpoint">LLM API Base URL:</label> <input type="text" id="apiEndpoint" name="apiEndpoint" placeholder="例如: https://generativelanguage.googleapis.com" required> </div>
                    <div class="config-item"> <label for="modelName">LLM 模型名称:</label> <input type="text" id="modelName" name="modelName" placeholder="例如: gemini-1.5-flash-latest" required> </div>
                 </div>
             </fieldset>

             <fieldset>
                 <legend>生成与通知参数</legend>
                 <div class="config-grid">
                    <div class="config-item"> <label for="temperature">Temperature:</label> <input type="number" id="temperature" name="temperature" min="0" max="2" step="0.1" placeholder="例如: 0.6 (默认)"> </div>
                    <div class="config-item"> <label for="maxOutputTokens">Max Output Tokens:</label> <input type="number" id="maxOutputTokens" name="maxOutputTokens" min="1" step="1" placeholder="例如: 8192 (默认)"> </div>
                 </div>
                 <div class="config-grid">
                     <div class="config-item">
                         <label for="successSoundPath">成功提示音路径:</label>
                         <input type="text" id="successSoundPath" name="successSoundPath" placeholder="服务器可访问的完整路径">
                         <label class="sound-path-label">服务器端文件路径</label>
                     </div>
                     <div class="config-item">
                         <label for="failureSoundPath">失败提示音路径:</label>
                         <input type="text" id="failureSoundPath" name="failureSoundPath" placeholder="服务器可访问的完整路径">
                          <label class="sound-path-label">服务器端文件路径</label>
                     </div>
                 </div>
                 <div>
                     <button type="button" id="saveParamsButton" class="secondary">保存 API 参数</button>
                     <button type="button" id="loadParamsButton" class="secondary">加载 API 参数</button>
                     <span id="param-status"></span>
                 </div>
             </fieldset>

            <fieldset>
                <legend>人物设定 (用于生成 NAI 提示词)</legend>
                <div id="characterProfilesArea">
                    <div>
                        <button type="button" id="loadProfileFileButton" class="secondary">加载设定文件 (.json)</button>
                        <button type="button" id="saveProfileFileButton" class="secondary" disabled>保存当前设定到文件</button>
                        <span id="profileFileName" style="margin-left: 15px; font-style: italic; color: #555;">未加载文件</span>
                    </div>
                    <hr style="margin: 15px 0;">
                    <p style="font-size: 0.9em; color: #666;">加载文件后，您可以在下方编辑设定，或点击“添加人物”新增。编辑后记得点击“保存当前设定到文件”。</p>
                    <div id="profilesList"></div>
                    <button type="button" id="addProfileButton" class="secondary">添加人物</button>
                    <span id="profile-status" style="font-size: 0.85em; margin-left: 10px;"></span>
                    <input type="file" id="profileFileInput" accept=".json" style="display: none;">
                </div>
            </fieldset>

            <fieldset>
                <legend>转换流程</legend>
                {/* --- 步骤一 --- */}
                <div>
                    <label for="preNovelText">前置指令 (可选, 用于步骤一):</label>
                    <textarea id="preNovelText" name="preNovelText" class="textarea-small" placeholder="例如：请仔细分析以下小说..."></textarea>
                    <label for="novelText">原始小说原文:</label>
                    <textarea id="novelText" name="novelText" required placeholder="在此粘贴需要处理的原始小说原文..."></textarea>
                    <label for="postNovelText">后置指令 (可选, 用于步骤一):</label>
                    <textarea id="postNovelText" name="postNovelText" class="textarea-small" placeholder="例如：确保标记完整。"></textarea>
                    <button type="button" id="preprocessButton">第一步：转换小说格式</button>
                    <span id="step1Status" class="status-indicator"></span>
                </div>

                {/* --- 步骤二 --- */}
                <div class="step-container">
                    <label for="structuredNovelText">步骤一结果 (格式化文本 - 可编辑):</label>
                    <textarea id="structuredNovelText" name="structuredNovelText" placeholder="步骤一的结果将显示在这里，您可以编辑或直接粘贴符合格式的文本..." style="background-color: #e8f4ff;"></textarea>
                    {/* Filename input before save button */}
                    <input type="text" id="formattedFilename" class="filename-input" placeholder="输入文件名 (无需.txt)">
                    <button type="button" id="saveFormattedButton" class="secondary" disabled>保存为 TXT</button>
                    <button type="button" id="enhancePromptsButton" disabled>第二步：添加 NAI 提示词</button>
                     <span id="step2Status" class="status-indicator"></span>
                </div>

                {/* --- 步骤三 --- */}
                 <div class="step-container">
                    <label for="enhancedNovelText">步骤二结果 (含 NAI 提示标记 - 可编辑):</label>
                    <textarea id="enhancedNovelText" name="enhancedNovelText" placeholder="步骤二的结果将显示在这里，您可以编辑后再进行步骤三..." style="background-color: #fff8e1;"></textarea>
                    {/* Filename input before save button */}
                    <input type="text" id="enhancedFilename" class="filename-input" placeholder="输入文件名 (无需.txt)">
                    <button type="button" id="saveEnhancedButton" class="secondary" disabled>保存为 TXT (含提示词)</button>
                    <button type="button" id="convertToKagButton" disabled>第三步：转 KAG 脚本</button>
                     <span id="step3Status" class="status-indicator"></span>
                 </div>

                 {/* --- 最终输出 --- */}
                 <div class="step-container">
                    <label for="outputKs">步骤三结果 (生成的 KAG 脚本):</label>
                    <textarea id="outputKs" readonly placeholder="最终 KAG 脚本结果将逐步显示在这里..."></textarea>
                    {/* Filename input before save button */}
                    <input type="text" id="ksFilename" class="filename-input" placeholder="输入文件名 (无需.ks)">
                    <button type="button" id="saveKsButton" class="secondary" disabled>保存为 .ks 文件 (UTF-16LE)</button>
                 </div>
            </fieldset>
        </form>
    </div>

    <script>
        // --- 获取所有元素 ---
        const apiKeyInput = document.getElementById('apiKey');
        const apiEndpointInput = document.getElementById('apiEndpoint');
        const modelNameInput = document.getElementById('modelName');
        const temperatureInput = document.getElementById('temperature');
        const maxOutputTokensInput = document.getElementById('maxOutputTokens');
        const successSoundPathInput = document.getElementById('successSoundPath');
        const failureSoundPathInput = document.getElementById('failureSoundPath');
        const saveParamsButton = document.getElementById('saveParamsButton');
        const loadParamsButton = document.getElementById('loadParamsButton');
        const paramStatusSpan = document.getElementById('param-status');
        // Profiles
        const profilesListDiv = document.getElementById('profilesList');
        const addProfileButton = document.getElementById('addProfileButton');
        const profileStatusSpan = document.getElementById('profile-status');
        const loadProfileFileButton = document.getElementById('loadProfileFileButton');
        const saveProfileFileButton = document.getElementById('saveProfileFileButton');
        const profileFileNameSpan = document.getElementById('profileFileName');
        const profileFileInput = document.getElementById('profileFileInput');
        // Steps
        const preNovelTextInput = document.getElementById('preNovelText');
        const novelTextInput = document.getElementById('novelText');
        const postNovelTextInput = document.getElementById('postNovelText');
        const structuredNovelTextarea = document.getElementById('structuredNovelText');
        const enhancedNovelTextarea = document.getElementById('enhancedNovelText');
        const outputKsTextarea = document.getElementById('outputKs');
        const preprocessButton = document.getElementById('preprocessButton');
        const saveFormattedButton = document.getElementById('saveFormattedButton');
        const enhancePromptsButton = document.getElementById('enhancePromptsButton');
        const convertToKagButton = document.getElementById('convertToKagButton');
        const step1StatusSpan = document.getElementById('step1Status');
        const step2StatusSpan = document.getElementById('step2Status');
        const step3StatusSpan = document.getElementById('step3Status');
        // New save buttons and inputs
        const saveEnhancedButton = document.getElementById('saveEnhancedButton');
        const saveKsButton = document.getElementById('saveKsButton');
        const formattedFilenameInput = document.getElementById('formattedFilename');
        const enhancedFilenameInput = document.getElementById('enhancedFilename');
        const ksFilenameInput = document.getElementById('ksFilename');

        // --- 全局变量 ---
        let characterProfiles = {};
        let sseBuffer = '';

        // --- Helper 函数 ---
        function parseSSE(chunk) { /* ... (保持不变) ... */
            const messages = []; sseBuffer += chunk; const parts = sseBuffer.split('\n\n'); sseBuffer = parts.pop() || ''; for (const part of parts) { if (!part.trim()) continue; const lines = part.split('\n'); let eventData = ''; let eventType = 'message'; for (const line of lines) { if (line.startsWith('event:')) { eventType = line.substring(6).trim(); } else if (line.startsWith('data:')) { eventData += line.substring(5).trim() + '\n'; } } eventData = eventData.trim(); if (eventData) { try { const jsonData = JSON.parse(eventData); messages.push({ type: eventType, data: jsonData }); } catch (e) { console.error("解析 SSE JSON 数据失败:", eventData, e); messages.push({ type: 'error', data: { message: "接收到无效的 JSON 数据: " + eventData.substring(0, 50) + "..." } }); } } } return messages;
        }
        function showNotification(title, body) { /* ... (保持不变) ... */
             if (!("Notification" in window)) { return; } if (Notification.permission === "granted") { new Notification(title, { body: body, icon: '/favicon.ico' }); } else if (Notification.permission !== "denied") { Notification.requestPermission().then((permission) => { if (permission === "granted") { new Notification(title, { body: body, icon: '/favicon.ico' }); } }); }
        }
        async function triggerSoundPlayback(isSuccess) { /* ... (保持不变) ... */
             const status = isSuccess ? "success" : "failure"; try { const response = await fetch('/play_sound', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: status }) }); if (!response.ok) {/* Ignore */} } catch (error) {/* Ignore */}
        }

        // --- 更新所有按钮状态 ---
        function updateAllButtonStates() {
            try {
                const step1OutputAvailable = structuredNovelTextarea && structuredNovelTextarea.value.trim() !== '';
                const step2OutputAvailable = enhancedNovelTextarea && enhancedNovelTextarea.value.trim() !== '';
                const step3OutputAvailable = outputKsTextarea && outputKsTextarea.value.trim() !== '';
                const profilesExist = Object.keys(characterProfiles).length > 0 || (profilesListDiv && profilesListDiv.querySelectorAll('.profile-entry').length > 0);

                if (saveFormattedButton) saveFormattedButton.disabled = !step1OutputAvailable;
                if (enhancePromptsButton) enhancePromptsButton.disabled = !step1OutputAvailable;
                if (saveEnhancedButton) saveEnhancedButton.disabled = !step2OutputAvailable;
                if (convertToKagButton) convertToKagButton.disabled = !step2OutputAvailable;
                if (saveKsButton) saveKsButton.disabled = !step3OutputAvailable;
                if (saveProfileFileButton) saveProfileFileButton.disabled = !profilesExist;

            } catch (e) { console.error("Error in updateAllButtonStates:", e); }
        }

        // --- 通用流式处理函数 ---
        async function processStream(targetTextarea, statusSpan, endpoint, payload, stepName) {
            // ... (保持不变, 内部调用 parseSSE) ...
            if (!targetTextarea || !statusSpan) { console.error(`processStream Error: target elements not found for step: ${stepName}`); return; }
            targetTextarea.value = ''; statusSpan.textContent = '正在初始化...'; statusSpan.className = 'status-indicator'; sseBuffer = '';
            if (preprocessButton) preprocessButton.disabled = true; if (saveFormattedButton) saveFormattedButton.disabled = true; if (enhancePromptsButton) enhancePromptsButton.disabled = true; if (saveEnhancedButton) saveEnhancedButton.disabled = true; if (convertToKagButton) convertToKagButton.disabled = true; if (saveKsButton) saveKsButton.disabled = true;
            let finalStatus = "unknown";
            try {
                statusSpan.textContent = '发送请求...';
                const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { let errorMsg = `后端错误 (${response.status})`; try { const errorJson = await response.json(); errorMsg += `: ${errorJson.error || '未知'}`; } catch (e) { errorMsg += `: ${response.statusText}`; } throw new Error(errorMsg); }
                if (!response.body) throw new Error('响应体为空');
                statusSpan.textContent = '接收数据...';
                const reader = response.body.getReader(); const decoder = new TextDecoder("utf-8"); finalStatus = "success";
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) { statusSpan.textContent = '处理完成!'; break; }
                    const decodedChunk = decoder.decode(value, { stream: true });
                    const messages = parseSSE(decodedChunk);
                    if (messages && messages.length > 0) {
                        for (const message of messages) {
                            if (message.type === 'error' || (message.data && message.data.type === 'error')) { const errorText = message.data.message || message.data.raw || "未知流错误"; console.error(`Stream Error (${stepName}):`, errorText); statusSpan.textContent = `错误: ${errorText}`; statusSpan.className = 'status-indicator error'; finalStatus = "error"; await reader.cancel(); return; }
                            else if (message.data && message.data.type === 'chunk') { targetTextarea.value += message.data.content; }
                            else if (message.data && (message.data.type === 'header' || message.data.type === 'footer')) { targetTextarea.value += message.data.content; }
                            else if (message.type === 'warning' || (message.data && message.data.type === 'warning')) { /* Warn */ }
                            else { console.warn(`Received unknown message structure (${stepName}):`, message); }
                            targetTextarea.scrollTop = targetTextarea.scrollHeight;
                        }
                        // Update button states as text arrives (or just at the end)
                        updateAllButtonStates();
                    }
                }
            } catch (error) {
                console.error(`Stream Error (${stepName} - ${endpoint}):`, error); statusSpan.textContent = `失败: ${error.message}`; statusSpan.className = 'status-indicator error'; finalStatus = "error";
            } finally {
                const isSuccess = finalStatus === "success";
                if (isSuccess) { showNotification(`${stepName} 完成`, "处理已成功结束。"); triggerSoundPlayback(true); }
                else { showNotification(`${stepName} 失败`, `处理过程中发生错误: ${statusSpan.textContent}`); triggerSoundPlayback(false); }
                if (preprocessButton) preprocessButton.disabled = false;
                updateAllButtonStates();
            }
        }

        // --- API 参数管理 ---
        async function saveApiParameters() { /* ... (保持不变) ... */
             console.log("saveApiParameters called"); paramStatusSpan.textContent = "正在保存 API 参数..."; paramStatusSpan.style.color = "#669";
             const paramsToSave = {}; paramsToSave.apiKey = apiKeyInput.value.trim(); paramsToSave.apiEndpoint = apiEndpointInput.value.trim(); paramsToSave.modelName = modelNameInput.value.trim(); paramsToSave.temperature = temperatureInput.value ? parseFloat(temperatureInput.value) : null; paramsToSave.maxOutputTokens = maxOutputTokensInput.value ? parseInt(maxOutputTokensInput.value, 10) : null; paramsToSave.successSoundPath = successSoundPathInput.value.trim(); paramsToSave.failureSoundPath = failureSoundPathInput.value.trim();
             try { const response = await fetch('/save_config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(paramsToSave) }); const result = await response.json(); if (response.ok) { paramStatusSpan.textContent = result.message || "API 参数已保存。"; paramStatusSpan.style.color = "green"; } else { throw new Error(result.error || `保存失败 (${response.status})`); } } catch (e) { console.error("保存 API 参数失败:", e); paramStatusSpan.textContent = `保存 API 参数失败: ${e.message}`; paramStatusSpan.style.color = "red"; } finally { setTimeout(() => { paramStatusSpan.textContent = ""; }, 4000); }
        }
        async function loadApiParameters() { /* ... (保持不变) ... */
             console.log("loadApiParameters called"); paramStatusSpan.textContent = "正在加载 API 参数..."; paramStatusSpan.style.color = "#669";
             try { const response = await fetch('/load_config'); if (!response.ok) { throw new Error(`加载配置请求失败 (${response.status})`); } const configData = await response.json(); if (configData.error) { throw new Error(configData.error); } let loaded = false; if (typeof configData === 'object' && configData !== null) { apiKeyInput.value = configData.apiKey || ''; apiEndpointInput.value = configData.apiEndpoint || ''; modelNameInput.value = configData.modelName || ''; temperatureInput.value = (configData.temperature !== null && configData.temperature !== undefined) ? configData.temperature : ''; maxOutputTokensInput.value = (configData.maxOutputTokens !== null && configData.maxOutputTokens !== undefined) ? configData.maxOutputTokens : ''; successSoundPathInput.value = configData.successSoundPath || ''; failureSoundPathInput.value = configData.failureSoundPath || ''; if (apiKeyInput.value || apiEndpointInput.value || modelNameInput.value) { loaded = true; } } if (loaded) { paramStatusSpan.textContent = "已加载 API 参数。"; paramStatusSpan.style.color = "blue"; } else { paramStatusSpan.textContent = "未找到或无有效 API 参数。"; paramStatusSpan.style.color = "#666"; } } catch (e) { console.error("加载 API 参数失败:", e); paramStatusSpan.textContent = `加载 API 参数失败: ${e.message}`; paramStatusSpan.style.color = "red"; } finally { setTimeout(() => { paramStatusSpan.textContent = ""; }, 4000); updateAllButtonStates(); }
        }

        // --- 保存步骤一结果 (带文件名处理) ---
        function saveFormattedText() {
           if (!structuredNovelTextarea || !formattedFilenameInput) { alert("错误：找不到所需元素。"); return; }
           const textToSave = structuredNovelTextarea.value;
           if (!textToSave.trim()) { alert("没有可保存的内容。"); return; }
           let filename = formattedFilenameInput.value.trim().replace(/[\\/:*?"<>|]/g, '_') || 'formatted_novel';
           filename += '.txt';
           const blob = new Blob([textToSave], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = filename; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a);
        }

        // --- 保存步骤二结果 (带文件名处理) ---
        function saveEnhancedText() {
           if (!enhancedNovelTextarea || !enhancedFilenameInput) { alert("错误：找不到所需元素。"); return; }
           const textToSave = enhancedNovelTextarea.value;
           if (!textToSave.trim()) { alert("步骤二没有可保存的内容。"); return; }
           let filename = enhancedFilenameInput.value.trim().replace(/[\\/:*?"<>|]/g, '_') || 'enhanced_novel';
           filename += '.txt';
           const blob = new Blob([textToSave], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = filename; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a);
       }

       // --- 保存步骤三结果为 .ks 文件 (UTF-16LE, 带文件名处理) ---
       function saveKsFile() {
           if (!outputKsTextarea || !ksFilenameInput) { alert("错误：找不到所需元素。"); return; }
           const textToSave = outputKsTextarea.value;
           if (!textToSave.trim()) { alert("步骤三没有可保存的内容。"); return; }
           let filename = ksFilenameInput.value.trim().replace(/[\\/:*?"<>|]/g, '_') || 'generated_script';
           filename += '.ks';
           try {
               const bom = "\uFEFF"; const textWithBom = bom + textToSave;
               const blob = new Blob([textWithBom], { type: 'text/plain;charset=utf-16le' });
               const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = filename; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a);
           } catch (e) { console.error("保存 KS 文件失败:", e); alert("保存 KS 文件失败。请尝试手动复制内容并使用文本编辑器保存为 UTF-16 LE 编码。"); }
       }

        // --- 人物设定管理 (使用 DOM 操作渲染) ---
        function renderProfilesList() { /* ... (保持不变, 使用 DOM 操作) ... */
            console.log("renderProfilesList called (Using DOM manipulation)");
            if (!profilesListDiv) { console.error("renderProfilesList Error: profilesListDiv is not found!"); return; }
            profilesListDiv.innerHTML = ''; if (typeof characterProfiles !== 'object' || characterProfiles === null) { characterProfiles = {}; }
            const names = Object.keys(characterProfiles).sort();
            if (names.length === 0) { profilesListDiv.innerHTML = '<p style="font-style: italic; color: #888;">请加载设定文件或点击“添加人物”。</p>'; }
            else {
                names.forEach(name => {
                    const profile = characterProfiles[name]; if (typeof profile !== 'object' || profile === null) { console.warn(`Skipping invalid profile data for name: ${name}`); return; }
                    const entryDiv = document.createElement('div'); entryDiv.className = 'profile-entry';
                    const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.dataset.type = 'name'; nameInput.value = name; nameInput.placeholder = '人物名称'; nameInput.title = name;
                    const posInput = document.createElement('input'); posInput.type = 'text'; posInput.dataset.type = 'positive'; posInput.value = profile.positive || ''; posInput.placeholder = '正面提示词 (tags)'; posInput.title = profile.positive || '';
                    const negInput = document.createElement('input'); negInput.type = 'text'; negInput.dataset.type = 'negative'; negInput.value = profile.negative || ''; negInput.placeholder = '负面提示词 (tags)'; negInput.title = profile.negative || '';
                    const removeButton = document.createElement('button'); removeButton.type = 'button'; removeButton.className = 'remove-profile-button'; removeButton.dataset.name = name; removeButton.textContent = '删除';
                    removeButton.addEventListener('click', handleRemoveProfile);
                    entryDiv.appendChild(nameInput); entryDiv.appendChild(posInput); entryDiv.appendChild(negInput); entryDiv.appendChild(removeButton);
                    profilesListDiv.appendChild(entryDiv);
                });
            }
            console.log("Profile list rendered with", names.length, "entries using DOM manipulation.");
            updateAllButtonStates();
        }
        function handleAddProfile() { /* ... (保持不变) ... */
            console.log("handleAddProfile called"); const newName = prompt("请输入新人物的名称：", ""); if (newName && newName.trim()) { const trimmedName = newName.trim(); if (!characterProfiles[trimmedName]) { characterProfiles[trimmedName] = { positive: "", negative: "" }; renderProfilesList(); profilesListDiv.scrollTop = profilesListDiv.scrollHeight; const newInput = profilesListDiv.querySelector(`.profile-entry input[data-type="name"][value="${trimmedName}"]`); if(newInput) { newInput.focus(); } else { console.warn(`handleAddProfile: Could not find input for "${trimmedName}" to focus.`); } profileStatusSpan.textContent = `已添加 "${trimmedName}" (点击保存生效)`; profileStatusSpan.style.color = '#666'; setTimeout(() => { profileStatusSpan.textContent = ""; }, 3000); } else { alert(`人物 "${trimmedName}" 已经存在！`); } }
        }
        function handleRemoveProfile(event) { /* ... (保持不变) ... */
            console.log("handleRemoveProfile called for", event.target.dataset.name); const nameToRemove = event.target.dataset.name; if (nameToRemove && characterProfiles[nameToRemove]) { if (confirm(`确定要删除人物 "${nameToRemove}" 的设定吗？`)) { delete characterProfiles[nameToRemove]; renderProfilesList(); profileStatusSpan.textContent = `人物 "${nameToRemove}" 已移除 (点击保存生效)`; profileStatusSpan.style.color = '#666'; setTimeout(() => { profileStatusSpan.textContent = ""; }, 3000); } }
        }

        // --- 文件加载/保存逻辑 ---
        function handleLoadProfileFileClick() { /* ... (保持不变) ... */
            if (profileFileInput) profileFileInput.click();
        }
        function loadProfileFromFile(event) { /* ... (保持不变) ... */
             const file = event.target.files[0]; if (!file) { return; } const reader = new FileReader(); reader.onload = (e) => { try { const content = e.target.result; const loadedData = JSON.parse(content); if (typeof loadedData === 'object' && loadedData !== null) { characterProfiles = loadedData; renderProfilesList(); if(profileFileNameSpan) { profileFileNameSpan.textContent = `已加载: ${file.name}`; profileFileNameSpan.title = file.name; } profileStatusSpan.textContent = "设定文件加载成功！"; profileStatusSpan.style.color = 'green'; } else { throw new Error("文件内容不是有效的 JSON 对象。"); } } catch (err) { console.error("加载或解析设定文件失败:", err); alert(`加载设定文件失败: ${err.message}`); profileStatusSpan.textContent = "加载文件失败！"; profileStatusSpan.style.color = 'red'; if(profileFileNameSpan) { profileFileNameSpan.textContent = "加载失败"; profileFileNameSpan.title = ""; } } finally { if(profileFileInput) profileFileInput.value = null; setTimeout(() => { profileStatusSpan.textContent = ""; }, 4000); } }; reader.onerror = (e) => { console.error("读取文件时出错:", e); alert("读取文件时出错。"); profileStatusSpan.textContent = "读取文件出错！"; profileStatusSpan.style.color = 'red'; if(profileFileNameSpan) { profileFileNameSpan.textContent = "读取错误"; profileFileNameSpan.title = ""; } if(profileFileInput) profileFileInput.value = null; setTimeout(() => { profileStatusSpan.textContent = ""; }, 4000); }; reader.readAsText(file);
        }
        function handleSaveProfileFileClick() { /* ... (保持不变) ... */
             const currentProfiles = {}; const entries = profilesListDiv.querySelectorAll('.profile-entry'); let valid = true; entries.forEach(entry => { const nameInput = entry.querySelector('input[data-type="name"]'); const posInput = entry.querySelector('input[data-type="positive"]'); const negInput = entry.querySelector('input[data-type="negative"]'); if (!nameInput || !posInput || !negInput) { valid = false; return; } const name = nameInput.value.trim(); if (name) { currentProfiles[name] = { positive: posInput.value.trim(), negative: negInput.value.trim() }; nameInput.style.borderColor = ''; } else { nameInput.style.borderColor = 'red'; valid = false; } }); if (!valid) { alert("错误：存在无效的人物设定条目（如缺少名字）！请修正后再保存。"); return; } if (Object.keys(currentProfiles).length === 0) { alert("没有可保存的人物设定。"); return; } const jsonString = JSON.stringify(currentProfiles, null, 2); const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = 'character_profiles.json'; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a); profileStatusSpan.textContent = "设定已导出，请保存文件。"; profileStatusSpan.style.color = 'blue'; setTimeout(() => { profileStatusSpan.textContent = ""; }, 4000); characterProfiles = currentProfiles;
        }

        // --- 页面加载与事件绑定 ---
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM fully loaded and parsed. Initializing final version...");
             // 验证元素
             let elementsVerified = true;
             const requiredElements = [apiKeyInput, apiEndpointInput, modelNameInput, temperatureInput, maxOutputTokensInput, successSoundPathInput, failureSoundPathInput, preNovelTextInput, novelTextInput, postNovelTextInput, structuredNovelTextarea, enhancedNovelTextarea, outputKsTextarea, preprocessButton, saveFormattedButton, enhancePromptsButton, convertToKagButton, step1StatusSpan, step2StatusSpan, step3StatusSpan, saveParamsButton, loadParamsButton, paramStatusSpan, profilesListDiv, addProfileButton, profileStatusSpan, loadProfileFileButton, saveProfileFileButton, profileFileNameSpan, profileFileInput, saveEnhancedButton, saveKsButton, formattedFilenameInput, enhancedFilenameInput, ksFilenameInput]; // Added filename inputs
             const requiredElementIDs = ['apiKey', 'apiEndpoint', 'modelName', 'temperature', 'maxOutputTokens', 'successSoundPath', 'failureSoundPath', 'preNovelText', 'novelText', 'postNovelText', 'structuredNovelText', 'enhancedNovelText', 'outputKs', 'preprocessButton', 'saveFormattedButton', 'enhancePromptsButton', 'convertToKagButton', 'step1Status', 'step2Status', 'step3Status', 'saveParamsButton', 'loadParamsButton', 'param-status', 'profilesList', 'addProfileButton', 'profile-status', 'loadProfileFileButton', 'saveProfileFileButton', 'profileFileNameSpan', 'profileFileInput', 'saveEnhancedButton', 'saveKsButton', 'formattedFilename', 'enhancedFilename', 'ksFilename']; // Added filename input IDs
             requiredElements.forEach((el, index) => {
                 if (!el) { console.error(`Error: Element with ID '${requiredElementIDs[index]}' not found!`); elementsVerified = false; }
             });
             if (!elementsVerified) { alert("页面初始化错误：缺少必要的 HTML 元素！"); return; }
             console.log("Final version: Element access verification complete.");

             // Request notification permission
             try { if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") { Notification.requestPermission(); } }
             catch (e) { console.error("Error requesting notification permission:", e); }

             // Load API parameters & Render empty profiles list
             try { loadApiParameters(); renderProfilesList(); }
             catch (e) { console.error("Error loading initial data:", e); }

             // Attach event listeners
             try {
                 saveParamsButton.addEventListener('click', saveApiParameters);
                 loadParamsButton.addEventListener('click', loadApiParameters);
                 saveFormattedButton.addEventListener('click', saveFormattedText);
                 addProfileButton.addEventListener('click', handleAddProfile);
                 loadProfileFileButton.addEventListener('click', handleLoadProfileFileClick);
                 saveProfileFileButton.addEventListener('click', handleSaveProfileFileClick);
                 profileFileInput.addEventListener('change', loadProfileFromFile);
                 saveEnhancedButton.addEventListener('click', saveEnhancedText); // Listener for new button
                 saveKsButton.addEventListener('click', saveKsFile);             // Listener for new button

                 // Input listeners for textareas to update button states
                 if (structuredNovelTextarea) { structuredNovelTextarea.addEventListener('input', updateAllButtonStates); }
                 if (enhancedNovelTextarea) { enhancedNovelTextarea.addEventListener('input', updateAllButtonStates); }
                 if (outputKsTextarea) { outputKsTextarea.addEventListener('input', updateAllButtonStates); }

                 preprocessButton.addEventListener('click', async () => { /* ... (no changes in logic) ... */
                     structuredNovelTextarea.value = ''; enhancedNovelTextarea.value = ''; outputKsTextarea.value = ''; updateAllButtonStates();
                     step1StatusSpan.textContent = ''; step1StatusSpan.className = 'status-indicator'; step2StatusSpan.textContent = ''; step2StatusSpan.className = 'status-indicator'; step3StatusSpan.textContent = ''; step3StatusSpan.className = 'status-indicator';
                     const apiKey = apiKeyInput.value.trim(); const apiBaseUrl = apiEndpointInput.value.trim().replace(/\/+$/, ''); const modelName = modelNameInput.value.trim(); let temperature = parseFloat(temperatureInput.value); if (isNaN(temperature) || temperature < 0 || temperature > 2) temperature = null; let maxOutputTokens = parseInt(maxOutputTokensInput.value, 10); if (isNaN(maxOutputTokens) || maxOutputTokens < 1) maxOutputTokens = null; const novelText = novelTextInput.value.trim(); const preNovelText = preNovelTextInput.value.trim(); const postNovelText = postNovelTextInput.value.trim();
                     if (!apiKey || !apiBaseUrl || !modelName || !novelText) { step1StatusSpan.textContent = '错误：API 配置和原始小说原文不能为空！'; step1StatusSpan.className = 'status-indicator error'; if(preprocessButton) preprocessButton.disabled = false; updateAllButtonStates(); return; }
                     const payload = { api_base_url: apiBaseUrl, model_name: modelName, api_key: apiKey, temperature: temperature, max_output_tokens: maxOutputTokens, pre_novel_text: preNovelText, novel_text: novelText, post_novel_text: postNovelText };
                     await processStream( structuredNovelTextarea, step1StatusSpan, '/preprocess_stream', payload, "步骤一 (格式化)" );
                 });

                 enhancePromptsButton.addEventListener('click', async () => { /* ... (no changes in logic) ... */
                     enhancedNovelTextarea.value = ''; outputKsTextarea.value = ''; updateAllButtonStates();
                     step2StatusSpan.textContent = ''; step2StatusSpan.className = 'status-indicator'; step3StatusSpan.textContent = ''; step3StatusSpan.className = 'status-indicator';
                     const apiKey = apiKeyInput.value.trim(); const apiBaseUrl = apiEndpointInput.value.trim().replace(/\/+$/, ''); const modelName = modelNameInput.value.trim(); let temperature = parseFloat(temperatureInput.value); if (isNaN(temperature) || temperature < 0 || temperature > 2) temperature = null; let maxOutputTokens = parseInt(maxOutputTokensInput.value, 10); if (isNaN(maxOutputTokens) || maxOutputTokens < 1) maxOutputTokens = null;
                     const formattedText = structuredNovelTextarea.value.trim();
                     const currentProfiles = {}; const entries = profilesListDiv.querySelectorAll('.profile-entry'); let profilesValid = true;
                     entries.forEach(entry => { const nameInput = entry.querySelector('input[data-type="name"]'); const posInput = entry.querySelector('input[data-type="positive"]'); const negInput = entry.querySelector('input[data-type="negative"]'); const name = nameInput.value.trim(); if (name) { currentProfiles[name] = { positive: posInput.value.trim(), negative: negInput.value.trim() }; nameInput.style.borderColor = ''; } else { nameInput.style.borderColor = 'red'; profilesValid = false; } });
                     if (!profilesValid) { step2StatusSpan.textContent = '错误：人物设定中存在空的人物名称！请修正后再试。'; step2StatusSpan.className = 'status-indicator error'; updateAllButtonStates(); return; }
                     if (Object.keys(currentProfiles).length === 0) { if (!confirm("警告：当前没有加载或定义任何人物设定。确定要继续吗？（将不会添加任何 NAI 提示）")) { updateAllButtonStates(); return; } }
                     const characterProfilesJson = JSON.stringify(currentProfiles);
                     if (!apiKey || !apiBaseUrl || !modelName || !formattedText) { step2StatusSpan.textContent = '错误：API 配置和步骤一结果不能为空！'; step2StatusSpan.className = 'status-indicator error'; updateAllButtonStates(); return; }
                     const payload = { api_base_url: apiBaseUrl, model_name: modelName, api_key: apiKey, temperature: temperature, max_output_tokens: maxOutputTokens, formatted_text: formattedText, character_profiles_json: characterProfilesJson };
                     await processStream( enhancedNovelTextarea, step2StatusSpan, '/enhance_with_prompts_stream', payload, "步骤二 (添加提示词)" );
                 });

                 convertToKagButton.addEventListener('click', async () => { /* ... (no changes in logic) ... */
                     outputKsTextarea.value = ''; updateAllButtonStates();
                     step3StatusSpan.textContent = ''; step3StatusSpan.className = 'status-indicator';
                     const apiKey = apiKeyInput.value.trim(); const apiBaseUrl = apiEndpointInput.value.trim().replace(/\/+$/, ''); const modelName = modelNameInput.value.trim(); let temperature = parseFloat(temperatureInput.value); if (isNaN(temperature) || temperature < 0 || temperature > 2) temperature = null; let maxOutputTokens = parseInt(maxOutputTokensInput.value, 10); if (isNaN(maxOutputTokens) || maxOutputTokens < 1) maxOutputTokens = null;
                     const enhancedText = enhancedNovelTextarea.value.trim();
                     if (!apiKey || !apiBaseUrl || !modelName || !enhancedText) { step3StatusSpan.textContent = '错误：API 配置和步骤二结果不能为空！'; step3StatusSpan.className = 'status-indicator error'; updateAllButtonStates(); return; }
                     const payload = { api_base_url: apiBaseUrl, model_name: modelName, api_key: apiKey, temperature: temperature, max_output_tokens: maxOutputTokens, enhanced_text: enhancedText };
                     await processStream( outputKsTextarea, step3StatusSpan, '/convert_stream', payload, "步骤三 (转 KAG)" );
                 });
                 console.log("Final version: Event listeners attached successfully.");
             } catch (e) {
                 console.error("Error attaching event listeners:", e);
                 alert("页面初始化错误：无法绑定按钮事件！");
             }

             // Initialize button states
             updateAllButtonStates();
             console.log("Final version: Initial button states set.");
         });
    </script>
</body>
</html>