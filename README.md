# 小说转 KAG 脚本工具 (novel_to_ks_app)

通过谷歌 AI (Gemini) 等大型语言模型，将小说文本分步转换为 KiriKiri2 (krkr) 引擎适用的 KAG 脚本 (.ks) 文件。

---

## 功能简介

本工具是一个基于 Web 的应用程序，旨在帮助用户将原始的小说文本转换为适用于 KiriKiri2 引擎的 KAG 脚本（`.ks` 文件）格式。它通过调用外部的 大型语言模型 (LLM) API（如 Google Gemini）分三步完成转换：

1.  **步骤一：格式化文本**：将原始小说文本进行预处理，自动识别说话人并在对话上方添加 `[名字]` 标记，识别内心独白并用 `*{{...}}*` 包裹。此步骤的输出结果可编辑，并可保存为 TXT 文件。
2.  **步骤二：添加 NAI 提示词**: 基于步骤一的结果和用户提供的人物基础设定（正面/负面提示词），调用 LLM **结合上下文**智能生成更具体的场景提示词，并将组合后的提示词以 `[NAI:...]` 标记插入到对应人物对话或动作之前。此步骤的输出结果可编辑，并可保存为 TXT 文件。
3.  **步骤三：转换为 KAG**: 将经过步骤二处理（包含 `[NAI:...]` 标记）的文本，转换为基本的 KAG 脚本，包含人物名称显示 (`[name]...[/name]`)、对话、旁白、心声和页面暂停 `[p]` 标签，同时将 `[NAI:...]` 标记转换为 KAG 注释。此步骤的结果可保存为 **UTF-16 LE 编码** 的 `.ks` 文件。

**核心特性：**

*   **三步转换**：将任务分解，允许用户在中间步骤检查、编辑和保存，并实现更复杂的 NAI 提示词动态生成。
*   **LLM 驱动**：利用 AI 能力自动进行格式化、提示词生成和 KAG 转换。
*   **流式输出**：转换结果逐步显示，无需等待整个过程完成。
*   **配置管理**：
    *   API 参数（密钥、URL、模型、声音路径等）可保存/加载到服务器端的 `config.json` 文件。
    *   人物基础设定可通过本地 `.json` 文件加载和保存。
*   **用户反馈**：通过状态指示器、浏览器桌面通知和可选的声音提示（需配置）告知用户处理进度和结果。
*   **结果保存与编辑**：
    *   步骤一、二的结果可编辑，并可输入自定义文件名保存为 `.txt` 文件。
    *   步骤三的结果可输入自定义文件名保存为 `.ks` 文件（UTF-16 LE 编码）。
*   **灵活流程**：虽然设计为三步流程，但用户可以通过编辑中间步骤的文本框，从任意步骤开始（例如，直接粘贴符合格式的文本到步骤一或步骤二的输出框）。

## 环境准备

在开始之前，请确保你的计算机（将要运行此工具的服务器端）已安装以下软件：

*   **Python**: 版本 3.7 或更高。([Python 官网](https://www.python.org/)) 安装时建议勾选 "Add Python to PATH"。
*   **pip**: Python 包管理器，通常随 Python 安装。命令行运行 `pip --version` 检查。

## 安装与设置

1.  **获取文件**:
    *   确保拥有以下三个文件，并将它们放在同一个文件夹（目录）中：
        *   `app.py` (后端 Flask 服务器代码)
        *   `index.html` (前端界面代码，应放在 `templates` 子文件夹内)
        *   `requirements.txt` (Python 依赖库列表)
    *   **重要**: `index.html` 文件必须放在与 `app.py` 同级的 `templates` 文件夹中。目录结构应如下：
        ```
        your_project_folder/
        ├── app.py
        ├── requirements.txt
        └── templates/
            └── index.html
        ```

2.  **打开命令行**: 打开操作系统的命令行界面 (cmd, PowerShell, Terminal)。

3.  **进入项目目录**: 使用 `cd` 命令切换到项目文件夹。
    ```bash
    cd path/to/your_project_folder
    ```

4.  **创建虚拟环境 (推荐)**:
    ```bash
    python -m venv venv
    ```

5.  **激活虚拟环境**:
    *   Windows: `venv\Scripts\activate`
    *   macOS / Linux: `source venv/bin/activate`
    *   成功后提示符前通常显示 `(venv)`。

6.  **安装依赖库**: 在**激活的虚拟环境**中运行：
    ```bash
    pip install -r requirements.txt
    ```
    *   等待 Flask, requests, pygame 安装完成。如果 `pygame` 安装失败或提示音频设备问题，声音提示功能将不可用，但程序主体仍可运行。

## 运行应用程序

1.  **启动服务器**: 确保在项目目录下且虚拟环境已激活，运行：
    ```bash
    python app.py
    ```

2.  **访问 Web 界面**:
    *   服务器启动后，命令行会显示运行地址，通常是 `http://127.0.0.1:5000/`。
    *   打开网页浏览器，访问该地址。

## 使用 Web 界面

Web 界面分为几个主要区域：

1.  **API 配置**:
    *   **LLM API Key**: 你的 Google Gemini API 密钥或其他兼容 API 的密钥。**注意安全**。
    *   **LLM API Base URL**: API 的基础地址 (例如 `https://generativelanguage.googleapis.com`)。
    *   **LLM 模型名称**: 使用的模型名称 (例如 `gemini-1.5-flash-latest`)。

2.  **生成与通知参数**:
    *   **Temperature**: 控制生成随机性 (0-2)。
    *   **Max Output Tokens**: 限制 LLM 输出长度。
    *   **成功/失败提示音路径**: 服务器可访问的声音文件路径（可选）。

3.  **参数保存/加载**:
    *   **保存 API 参数**: 保存当前 API 和通知参数到服务器 `config.json`。
    *   **加载 API 参数**: 从服务器 `config.json` 加载参数。

4.  **人物设定 (用于生成 NAI 提示词)**:
    *   **加载设定文件 (.json)**: 点击选择本地的 `.json` 文件（应包含类似 `{"人物A": {"positive": "...", "negative": "..."}, ...}` 的结构）来加载人物基础设定。加载成功后会显示文件名和内容列表。
    *   **保存当前设定到文件**: 将当前下方列表中显示的所有人物设定（包括手动添加或编辑的）导出为一个名为 `character_profiles.json` 的文件，提示用户保存到本地。
    *   **显示区域 (`profilesList`)**: 展示当前加载或手动添加的人物列表，可以直接在输入框中编辑名称、正面提示词、负面提示词。
    *   **添加人物**: 点击手动添加一个新的人物条目到列表中。
    *   **删除按钮**: 点击条目旁的删除按钮将其从列表中移除。
    *   **状态栏**: 显示加载/保存文件的状态信息。

5.  **转换流程 (三步式)**:
    *   **步骤一：转换小说格式**:
        *   **输入**: 前置指令 (可选)、原始小说原文、后置指令 (可选)。
        *   **操作**: 点击按钮，调用 LLM 添加 `[名字]` 和 `*{{...}}*` 标记。
        *   **输出**: “格式化文本”区域显示结果，**此区域可编辑**。
        *   **保存**: 可输入文件名（不含 `.txt`），点击“保存为 TXT”按钮将此区域内容保存到本地。
    *   **步骤二：添加 NAI 提示词**:
        *   **输入**: 步骤一的格式化文本（可编辑）、当前已加载或编辑的人物基础设定。
        *   **操作**: 点击按钮，调用 LLM 结合上下文和基础设定，智能生成并插入 `[NAI:...]` 标记。
        *   **输出**: “含 NAI 提示标记”区域显示结果，**此区域可编辑**。
        *   **保存**: 可输入文件名（不含 `.txt`），点击“保存为 TXT (含提示词)”按钮将此区域内容保存到本地。
    *   **步骤三：转 KAG 脚本**:
        *   **输入**: 步骤二包含 NAI 标记的文本（可编辑）。
        *   **操作**: 点击按钮，调用 LLM 将文本转换为 KAG 脚本，并将 `[NAI:...]` 转为注释。
        *   **输出**: “生成的 KAG 脚本”区域显示最终结果（只读）。
        *   **保存**: 可输入文件名（不含 `.ks`），点击“保存为 .ks 文件 (UTF-16LE)”按钮将此区域内容以 **UTF-16 LE (带 BOM)** 编码保存到本地。

6.  **反馈机制**:
    *   各步骤旁的状态指示器。
    *   完成或失败时的浏览器桌面通知（需授权）。
    *   可选的声音提示。

## 常见工作流程

*   **完整流程**: 配置API -> 加载/创建人物设定 -> 粘贴原文 -> 步骤一 -> (编辑/保存) -> 步骤二 -> (编辑/保存) -> 步骤三 -> 输入文件名 -> 保存KS。
*   **使用已有格式化文本**: 配置API -> 加载/创建人物设定 -> 粘贴格式化文本到**步骤一输出框** -> 步骤二 -> (编辑/保存) -> 步骤三 -> 输入文件名 -> 保存KS。
*   **使用已有含提示词文本**: 配置API -> 粘贴含提示词文本到**步骤二输出框** -> 步骤三 -> 输入文件名 -> 保存KS。

## 重要提示与故障排除

*   **API Key 安全**: `config.json` 存储在服务器端，注意保密。
*   **人物设定文件**: 用户自行管理加载和保存的 `.json` 文件。请确保 JSON 格式正确。
*   **声音路径**: 必须是**服务器**可访问的路径。检查 `app.py` 启动日志看 `pygame` 是否初始化成功。
*   **LLM 成本与配额**: 注意 API 调用量。
*   **LLM 输出质量**: AI 生成结果（特别是步骤二的动态提示词）可能需要人工调整。最终 KAG 脚本也需要检查和补充（图像、声音等）。
*   **文件编码**: 保存的 `.ks` 文件是 UTF-16 LE 编码。请使用 Notepad++、VS Code 等能正确识别和编辑此编码的文本编辑器。用 Windows 自带记事本打开可能仍显示不正常或保存时破坏编码。
*   **网络问题**: 检查服务器网络连接和 API 服务状态。
*   **依赖安装失败**: 检查 Python 和 pip 是否正常，`pygame` 失败不影响核心功能。
*   **长时间无响应/卡顿**: 可能是网络问题、LLM API 问题或处理文本过长。尝试刷新或分段处理。
*   **浏览器缓存**: 如果遇到奇怪的前端行为或错误，尝试强制刷新 (`Ctrl+Shift+R`) 或清除浏览器缓存。

## 停止应用程序

*   在运行 `python app.py` 的命令行窗口按下 `Ctrl + C`。

---

## 更新日志

*   **2025-04-08**:
    *   **新增三步转换流程**:
        *   步骤一：基础格式化（识别说话人、心声）。
        *   步骤二：添加 NAI 提示词（结合上下文和人物基础设定动态生成）。
        *   步骤三：转换为 KAG 脚本（将 NAI 提示词转为注释）。
    *   **新增人物设定管理**:
        *   支持添加、编辑、删除人物及其基础 NAI 提示词（正面/负面）。
        *   支持通过加载本地 `.json` 文件导入人物设定。
        *   支持将当前人物设定导出保存为本地 `.json` 文件。
    *   **新增文件保存选项**:
        *   步骤一、二的结果可以输入文件名并保存为 `.txt` 文件。
        *   步骤三的结果可以输入文件名并保存为 `.ks` 文件，编码为 **UTF-16 LE (带 BOM)** 以兼容 KiriKiri2。
    *   **界面调整**: 增加了人物设定区域，调整了步骤布局。
    *   **Prompt 优化**: 大幅改进了步骤二和步骤三的 Prompt，以支持动态提示词生成和 NAI 标记的处理。
    *   **代码健壮性提升**: 改进了 JavaScript 中的 DOM 操作方式（使用 `createElement` 替代 `innerHTML`），修复了若干 Bug。
    *   **文本框可编辑**: 步骤一和步骤二的输出结果文本框现在允许用户编辑。
