# novel_to_ks_app
通过谷歌AI，把小说转krkr的ks脚本
好的，这是一份详细的使用说明，涵盖了从安装到使用的完整流程。

---

## 小说转 KAG 脚本工具 - 使用说明

### 1. 功能简介

本工具是一个基于 Web 的应用程序，旨在帮助用户将原始的小说文本转换为适用于 KiriKiri2 引擎的 KAG 脚本（`.ks` 文件）格式。它通过调用外部的 大型语言模型 (LLM) API（如 Google Gemini）分两步完成转换：

1.  **步骤一：格式化文本**：将原始小说文本进行预处理，自动识别说话人并在对话上方添加 `[名字]` 标记，识别内心独白并用 `*{{...}}*` 包裹。此步骤的输出结果可以保存为 TXT 文件。
2.  **步骤二：转换为 KAG**：将经过步骤一格式化（或用户手动整理好格式）的文本，转换为基本的 KAG 脚本，包含人物名称显示、对话、旁白和页面暂停 `[p]` 标签。

**核心特性：**

*   **两步转换**：将复杂的任务分解，提高准确性，并允许用户在中间步骤进行检查和修改。
*   **LLM 驱动**：利用 AI 能力自动识别和转换文本。
*   **流式输出**：转换结果逐步显示，无需等待整个过程完成。
*   **配置保存/加载**：API 密钥、模型名称、声音路径等参数可保存到服务器，方便下次使用。
*   **用户反馈**：通过状态指示器、浏览器桌面通知和可选的声音提示（需配置）告知用户处理进度和结果。
*   **结果保存**：步骤一的格式化结果可以方便地保存为本地 TXT 文件。
*   **灵活流程**：可以直接从符合格式的文本开始执行步骤二。

### 2. 环境准备

在开始之前，请确保你的计算机（将要运行此工具的服务器端）已安装以下软件：

*   **Python**: 版本 3.7 或更高。你可以从 [Python 官网](https://www.python.org/) 下载并安装。安装时请确保勾选 "Add Python to PATH"（或类似选项）。
*   **pip**: Python 的包管理器，通常会随 Python 一起安装。你可以在命令行（终端或命令提示符）中运行 `pip --version` 来检查是否安装成功。

### 3. 安装与设置

1.  **获取文件**:
    *   确保你拥有以下三个文件，并将它们放在同一个文件夹（目录）中：
        *   `app.py` (后端服务器代码)
        *   `index.html` (前端界面代码)
        *   `requirements.txt` (依赖库列表)

2.  **打开命令行**:
    *   在你的操作系统中打开一个命令行界面（例如：Windows 上的 `cmd` 或 `PowerShell`，macOS 或 Linux 上的 `Terminal`）。

3.  **进入项目目录**:
    *   使用 `cd` 命令切换到你存放上述三个文件的文件夹。例如：
        ```bash
        cd path/to/your/folder
        ```
        (将 `path/to/your/folder` 替换为实际的文件夹路径)

4.  **创建虚拟环境 (推荐)**:
    *   为了避免与系统中其他 Python 项目产生库版本冲突，强烈建议创建一个虚拟环境。在项目目录下运行：
        ```bash
        python -m venv venv
        ```
    *   这会创建一个名为 `venv` 的子目录，包含独立的 Python 环境。

5.  **激活虚拟环境**:
    *   **Windows**:
        ```bash
        venv\Scripts\activate
        ```
    *   **macOS / Linux**:
        ```bash
        source venv/bin/activate
        ```
    *   激活成功后，你的命令行提示符前面通常会显示 `(venv)`。

6.  **安装依赖库**:
    *   在**已激活虚拟环境**的命令行中，运行以下命令来安装 `requirements.txt` 文件中列出的所有必需库 (Flask, requests, pygame)：
        ```bash
        pip install -r requirements.txt
        ```
    *   等待安装完成。`pygame` 库可能会需要一些时间，并可能依赖系统上的一些多媒体库。如果 `pygame` 安装失败，程序仍然可以运行，但声音提示功能将不可用。

### 4. 运行应用程序

1.  **启动服务器**:
    *   确保你仍然在项目目录中，并且虚拟环境已激活（如果使用了虚拟环境）。
    *   运行以下命令启动 Flask Web 服务器：
        ```bash
        python app.py
        ```

2.  **访问 Web 界面**:
    *   启动成功后，命令行会显示类似以下的输出：
        ```
         * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
         * Restarting with stat
         * Debugger is active!
         * Debugger PIN: ...
        ```
    *   打开你的网页浏览器（如 Chrome, Firefox, Edge 等）。
    *   在地址栏输入 `http://127.0.0.1:5000/` 并访问。
    *   你应该能看到 "小说章节转 KAG 脚本" 的 Web 界面。

### 5. 使用 Web 界面

Web 界面分为几个主要区域：

1.  **API 配置**:
    *   **LLM API Key**: 输入你的 LLM API 密钥。这是调用 AI 服务所必需的凭证。**注意：此密钥会保存在服务器端的 `config.json` 文件中，请妥善保管。**
    *   **LLM API Base URL**: 输入 LLM API 的基础地址。对于 Google Gemini API，通常是 `https://generativelanguage.googleapis.com`。
    *   **LLM 模型名称**: 输入你要使用的具体模型名称，例如 "gemini-2.5-pro-exp-03-25"。

2.  **生成与通知参数**:
    *   **Temperature**: 控制生成文本的随机性。较低的值（如 0.2）使输出更确定、更集中；较高的值（如 0.8）使输出更多样、更具创意。留空则使用模型的默认值（通常在 0.6-0.9 之间）。有效范围通常是 0 到 1 或 2 之间。
    *   **Max Output Tokens**: 限制单次 API 调用生成的最大文本长度（Token 数）。有助于控制成本和防止输出过长。留空则使用模型的默认值。
    *   **成功提示音路径 / 失败提示音路径**:
        *   **重要**: 这里需要填写 **服务器** 可以访问到的声音文件的 **绝对路径** 或相对路径（相对于 `app.py`）。例如：
            *   Windows: `C:/Sounds/success.wav`
            *   Linux/macOS: `/home/user/sounds/ok.mp3`
            *   或者，如果声音文件放在与 `app.py` 同级的 `sounds` 文件夹下：`sounds/success.wav`
        *   如果留空，或者路径无效，或者服务器上没有安装 `pygame` 或无法初始化音频设备，则对应的声音提示不会播放。支持常见的音频格式（如 WAV, MP3, OGG）。

3.  **参数保存/加载**:
    *   **保存参数到服务器**: 点击此按钮会将当前填写的 API 配置、生成参数和声音路径保存到服务器项目目录下的 `config.json` 文件中。
    *   **从服务器加载参数**: 点击此按钮会从 `config.json` 文件读取之前保存的参数，并填充到页面对应的输入框中。
    *   旁边的状态栏会显示保存/加载操作的结果。

4.  **输入与输出**:
    *   **前置指令 (可选, 用于步骤一)**: 可以在这里输入一些对步骤一的额外要求或说明，会加在原始文本之前发送给 LLM。
    *   **原始小说原文**: 在此粘贴你需要转换的原始小说文本。这是步骤一的主要输入。
    *   **后置指令 (可选, 用于步骤一)**: 可以在这里输入一些补充要求，会加在原始文本之后发送给 LLM。
    *   **第一步：转换小说格式** 按钮: 点击开始执行步骤一。处理过程中按钮会禁用。
    *   **步骤一状态指示器**: 显示步骤一的运行状态（初始化、发送请求、接收数据、完成、错误）。
    *   **格式化后的小说文本**: 步骤一处理后的结果会逐步显示在这里。你可以检查结果，并**直接编辑**此区域的内容。
    *   **保存为 TXT** 按钮: **只有在步骤一成功完成后**，此按钮才会启用。点击后会将“格式化后的小说文本”区域的内容保存为一个名为 `preprocessed_novel.txt` 的文本文件到你的本地下载文件夹。
    *   **第二步：格式转 KAG** 按钮:
        *   当“格式化后的小说文本”区域**有内容时**（无论是步骤一生成还是你手动粘贴/编辑），此按钮会启用。
        *   点击后开始执行步骤二，将“格式化后的小说文本”转换为 KAG 脚本。处理过程中按钮会禁用。
    *   **步骤二状态指示器**: 显示步骤二的运行状态。
    *   **生成的 KAG 脚本 (.ks)**: 步骤二处理后的 KAG 脚本结果会逐步显示在这里。这是最终的输出，你可以复制粘贴到你的 `.ks` 文件中。

5.  **反馈机制**:
    *   **状态指示器**: 每个步骤按钮旁边都有文本实时显示当前状态。
    *   **浏览器通知**: 当步骤一或步骤二完成（无论成功或失败）时，如果浏览器支持且你已授予权限，会弹出桌面通知。首次使用时浏览器可能会询问是否允许通知。
    *   **声音提示**: 如果配置了有效的成功/失败声音文件路径，并且服务器环境支持（pygame 可用），则在步骤完成时会播放对应的声音。

### 6. 常见工作流程

*   **标准流程 (原文 -> KAG)**:
    1.  填写或加载 API 配置和参数。
    2.  将原始小说粘贴到“原始小说原文”区域。
    3.  点击“第一步：转换小说格式”。
    4.  等待处理完成，检查“格式化后的小说文本”区域的结果，可进行编辑。
    5.  （可选）点击“保存为 TXT”备份格式化后的文本。
    6.  点击“第二步：格式转 KAG”。
    7.  等待处理完成，从“生成的 KAG 脚本 (.ks)”区域复制结果。

*   **直接转换流程 (已有格式化文本 -> KAG)**:
    1.  填写或加载 API 配置和参数。
    2.  将**已经符合格式**（包含 `[名字]` 和 `*{{...}}*` 标记）的文本直接粘贴到“格式化后的小说文本”区域。
    3.  此时，“第二步：格式转 KAG”按钮应该会自动启用。
    4.  点击“第二步：格式转 KAG”。
    5.  等待处理完成，从“生成的 KAG 脚本 (.ks)”区域复制结果。

### 7. 重要提示与故障排除

*   **API Key 安全**: `config.json` 文件存储在服务器上。请确保服务器的文件系统安全，不要将包含敏感 API Key 的 `config.json` 文件分享或上传到公共仓库。
*   **声音路径**: 声音播放失败最常见的原因是路径错误或 `pygame` 问题。请确保路径是服务器可以访问的 **绝对路径** 或相对于 `app.py` 的正确相对路径，并且服务器具有读取该文件的权限。检查 `app.py` 启动时的命令行输出，看是否有关于 `pygame` 初始化失败的警告。
*   **LLM 成本与配额**: 调用 LLM API 通常需要付费或有使用限制。请注意你的 API 使用量和相关费用。
*   **LLM 输出质量**: AI 生成的结果可能不完美，尤其是对于复杂或不明确的文本。最终的 KAG 脚本仍需人工检查和调整，特别是图像、声音、特效等标签需要手动添加。
*   **网络问题**: 如果无法连接到 LLM API，请检查服务器的网络连接和防火墙设置。
*   **依赖安装失败**: 如果 `pip install -r requirements.txt` 失败，特别是 `pygame`，请检查错误信息，可能需要安装额外的系统库（如 SDL 库）。如果声音不是必需的，可以忽略 `pygame` 的失败，程序主体功能仍可使用。
*   **长时间无响应**: 如果某个步骤长时间卡在“接收数据”等状态，可能是网络连接中断或 LLM API 服务端出现问题。可以尝试刷新页面或重启 `app.py`。

### 8. 停止应用程序

当你使用完毕后，可以停止后端服务器：

*   回到你运行 `python app.py` 的命令行窗口。
*   按下 `Ctrl + C` 组合键。
*   服务器会停止运行。之后浏览器将无法访问 `http://127.0.0.1:5000/`。

---

希望这份说明能帮助你顺利使用这个工具！
